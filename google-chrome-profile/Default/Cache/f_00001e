define(["require","view!button","view!input-button","view!listview","common/MCDEvent","common/ui/keyboard/KeyboardStore","common/ui/keyboard/Constants"],function(require){"use strict";var buttonView=require("view!button"),inputButton=require("view!input-button"),listview=require("view!listview"),MCDEvent=require("common/MCDEvent"),KeyboardStore=require("common/ui/keyboard/KeyboardStore"),Constants=require("common/ui/keyboard/Constants"),LOWER_CASE="lower-case",UPPER_CASE="upper-case",CAPS_LOCK="caps-lock-case",ALPHA_STATE="alpha",NUMERIC_STATE="numeric",alphas,numerics,editText,parent,keyboardWrapper,alphaWrapper,numericWrapper,spaceButton,keyboards={},initialText,keycharClass,currentLocale=KeyboardStore[0].locale;KeyboardStore.forEach(function(keyboard){keyboards[keyboard.locale]=keyboard.handlerClass});var currentKeyboard=keyboards[currentLocale],Keyboard={build:function(params){initialText=params.text,keycharClass=params.charType;var shiftState=UPPER_CASE,keysState=ALPHA_STATE,shift=function(toCase){toCase===undefined&&(shiftState===UPPER_CASE?(toCase=CAPS_LOCK,shiftState=CAPS_LOCK):shiftState===CAPS_LOCK?toCase=LOWER_CASE:shiftState===LOWER_CASE&&(toCase=UPPER_CASE)),toCase===UPPER_CASE?(alphas.forEach(function(row){row.forEach(function(key){!key.action&&key.text&&(key["upper-case"]?(key["lower-case"]=key.text,key.text=key["upper-case"]):key.text=key.text.toUpperCase())})}),shiftState=UPPER_CASE):toCase===LOWER_CASE&&(alphas.forEach(function(row){row.forEach(function(key){!key.action&&key.text&&(key["lower-case"]?key.text=key["lower-case"]:key.text=key.text.toLowerCase())})}),shiftState=LOWER_CASE)},editTextModel={text:params.text||"",attributes:{onRight:"keyboard-backspace",onLeft:null,onUp:null}},textButtonConfig={text:editTextModel,inputModifier:"left",button:{icon:{src:"long-arrow-left",fontSize:Constants.ICON_SIZE,position:"center",width:"53px",height:"100%"},$click:function(){editText.backspace()},attributes:{onLeft:"keyboard-edit-text",onRight:function(){var firstKey;if(keysState===ALPHA_STATE){firstKey=alphaWrapper.querySelector(".key-row:first-child button:first-child");while(firstKey&&firstKey.getAttribute("disabled"))firstKey=firstKey.nextElementSibling;firstKey.focusTarget.requestFocus()}else{firstKey=numericWrapper.querySelector(".key-row:first-child button:first-child");while(firstKey&&firstKey.getAttribute("disabled"))firstKey=firstKey.nextElementSibling;firstKey.focusTarget.requestFocus()}}}}},keyboardHeader=inputButton(textButtonConfig,"keyboard-header");editText=keyboardHeader.querySelector("oc-input"),editText.charClass=keycharClass,editText.id="keyboard-edit-text";var fn=editText.__attached;editText.__attached=function(){fn.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Joystick.DOWN|MCDEvent.EventType.Wheel.FORWARD|MCDEvent.EventType.Wheel.BACK,function(event){var lastTarget;if(event.eventType&MCDEvent.EventType.Joystick.DOWN)keysState===ALPHA_STATE?(lastTarget=this.prevTarget,lastTarget?lastTarget.requestFocus():alphaWrapper.querySelector("[defaultEditTextTarget]").focusTarget.requestFocus()):(lastTarget=this.prevTarget,lastTarget?lastTarget.requestFocus():numericWrapper.querySelector("[defaultEditTextTarget]").focusTarget.requestFocus()),event.stopPropagation();else if(event.eventType&MCDEvent.EventType.Wheel.FORWARD){event.stopPropagation();var kR=document.getElementById(this.focusTarget.onRight);kR&&kR.focusTarget&&kR.focusTarget.requestFocus()}else if(event.eventType&MCDEvent.EventType.Wheel.BACK){event.stopPropagation();var kL=document.getElementById(this.focusTarget.onLeft);kL&&kL.focusTarget&&kL.focusTarget.requestFocus()}}.bind(this))};var backspaceButton=keyboardHeader.querySelector("button");backspaceButton.id="keyboard-backspace";var fn1=backspaceButton.__attached;backspaceButton.__attached=function(){fn1.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Joystick.DOWN|MCDEvent.EventType.Wheel.FORWARD|MCDEvent.EventType.Wheel.BACK,function(event){if(event.eventType&MCDEvent.EventType.Joystick.DOWN)keysState===ALPHA_STATE?alphaWrapper.querySelector("[defaultBackspaceTarget]").focusTarget.requestFocus():numericWrapper.querySelector("[defaultBackspaceTarget]").focusTarget.requestFocus(),event.stopPropagation();else if(event.eventType&MCDEvent.EventType.Wheel.FORWARD){event.stopPropagation();var firstKey;if(keysState===ALPHA_STATE){firstKey=alphaWrapper.querySelector(".key-row:first-child button:first-child");while(firstKey&&firstKey.getAttribute("disabled"))firstKey=firstKey.nextElementSibling;firstKey.focusTarget.requestFocus()}else{firstKey=numericWrapper.querySelector(".key-row:first-child button:first-child");while(firstKey&&firstKey.getAttribute("disabled"))firstKey=firstKey.nextElementSibling;firstKey.focusTarget.requestFocus()}}else if(event.eventType&MCDEvent.EventType.Wheel.BACK){event.stopPropagation();var l=document.getElementById(this.focusTarget.onLeft);l&&l.focusTarget&&l.focusTarget.requestFocus()}}.bind(this))};var showLocaleSwitcher=function(parent){var switcher=parent.element.querySelector(".locale-switcher");switcher.style.display="block";var keyboard=parent.element.querySelector(".keyboard");keyboard.style.display="none";var lv;switcher.childElementCount===0?(lv=listview({title:"Select Keyboard",list:KeyboardStore.map(function(keyboard){return{text:keyboard.label,locale:keyboard.locale}}),itemClick:function(lv,model){buildKeyboardByLocale(model.get("locale")),window.requestAnimationFrame(function(){reset(parent.element),showKeyboard(parent)})},onBackButtonClicked:function(){showKeyboard(parent)},onBackEvent:function(event){showKeyboard(parent),event.stopPropagation(),event.preventDefault()}}),switcher.appendChild(lv.element),lv.focus(parent)):(lv=switcher.querySelector(".oc-list-view-container").getControl(),lv.focus())},showKeyboard=function(parent){var switcher=parent.element.querySelector(".locale-switcher");switcher.style.display="none";var keyboard=parent.element.querySelector(".keyboard");keyboard.style.display="block",parent.element.querySelector(".locale-switcher-btn").focusTarget.requestFocus()},toggleAlpha=function(){var alphaPane=this.querySelector(".alpha");alphaPane.style.display="block";var firstChild=alphaPane.querySelector(".toggle-alpha");firstChild.focusTarget.requestFocus(),this.querySelector(".numeric").style.display="none",editText.prevTarget=spaceButton.prevTarget=null,keysState=ALPHA_STATE},toggleNumbericKeys=function(){this.querySelector(".alpha").style.display="none";var numericPane=this.querySelector(".numeric");numericPane.style.display="block";var firstChild=numericPane.querySelector(".toggle-alpha");firstChild.focusTarget.requestFocus(),editText.prevTarget=spaceButton.prevTarget=null,keysState=NUMERIC_STATE},search=function(elementToFocus,focusElement){if(elementToFocus.getAttribute("disabled")){while(elementToFocus.getAttribute("disabled")){if(!elementToFocus.previousElementSibling||elementToFocus.previousElementSibling===focusElement)break;elementToFocus=elementToFocus.previousElementSibling}while(elementToFocus.getAttribute("disabled")){if(!elementToFocus.nextElementSibling||elementToFocus.nextElementSibling===focusElement)break;elementToFocus=elementToFocus.nextElementSibling}return elementToFocus}return elementToFocus},loopRightDown=function(element){var nextParent=element.parentNode.nextElementSibling;if(nextParent){var firstChild=nextParent.firstElementChild;return firstChild?search(firstChild,element):element}return element},onRight=function(){var rightElement=this.focusElement.nextElementSibling;return rightElement?(rightElement=search(rightElement,this.focusElement),rightElement.getAttribute("disabled")&&(rightElement=loopRightDown(rightElement)),rightElement):loopRightDown(this.focusElement)},loopLeftUp=function(element){var previousParent=element.parentNode.previousElementSibling;if(previousParent){var lastChild=previousParent.lastElementChild;return lastChild?search(lastChild,element):element}return element},onLeft=function(){var leftElement=this.focusElement.previousElementSibling;return leftElement?(leftElement=search(leftElement,this.focusElement),leftElement.getAttribute("disabled")&&(leftElement=loopLeftUp(leftElement)),leftElement):loopLeftUp(this.focusElement)},onUp=function(){var parent=this.focusElement.parentNode,elementIndex=Array.prototype.indexOf.call(parent.children,this.focusElement),prevParent=parent.previousElementSibling;if(prevParent){var elementToFocus=prevParent.children[Math.min(elementIndex,prevParent.childElementCount-1)];return search(elementToFocus,this.focusElement)}return this.focusElement},onDown=function(){var parent=this.focusElement.parentNode,elementIndex=Array.prototype.indexOf.call(parent.children,this.focusElement),nextParent=parent.nextElementSibling;if(nextParent){var elementToFocus=nextParent.children[Math.min(elementIndex,nextParent.childElementCount-1)];return search(elementToFocus,this.focusElement)}return this.focusElement},removeSwitcher=function(){var switcher=parent.element.querySelector(".locale-switcher");if(switcher){var container=switcher.querySelector(".oc-list-view-container");if(container){var switcherLV=container.getControl();switcherLV&&(switcherLV.getParentFocusTarget()._removeChild(switcherLV),switcherLV.remove(),switcher.parentNode.remove(switcher))}}},buildKeys=function(keys,wrapper,parent){var onButtonClicked=function(e){var model=this.model;if(!model.action){var letter=this.getAttribute("text");editText.type(letter)}else switch(model.action){case Constants.TOGGLE_NUMERIC_ACTION:toggleNumeric.call(parent.element);break;case Constants.CLOSE_DIALOG_ACTION:removeSwitcher(),parent.hide.call(parent,editText.model.text,Constants.CLOSE_DIALOG_ACTION),e.stopPropagation();break;case Constants.CANCEL_DIALOG_ACTION:removeSwitcher(),editText.clear(),editText.type(params.text),parent.hide.call(parent,initialText,Constants.CANCEL_DIALOG_ACTION),e.stopPropagation();break;case Constants.SHIFT_ACTION:shift(),shiftState===CAPS_LOCK?this.model.icon.src="arrow-circle-up":this.model.icon.src!=="arrow-circle-o-up"&&(this.model.icon.src="arrow-circle-o-up"),e.stopPropagation();break;case Constants.SPACE_ACTION:editText.space.call(editText);break;case Constants.SWITCH_LOCALE_ACTION:showLocaleSwitcher(parent)}},buttonClicked=function(e){currentKeyboard.onButtonClicked(e,this),e.canceled||onButtonClicked.call(this,e),e.canceled||shiftState===UPPER_CASE&&shift(LOWER_CASE)},toggleNumeric=function(){keysState===ALPHA_STATE?toggleNumbericKeys.call(this):toggleAlpha.call(this)},rowDiv;keys.forEach(function(row,rowIndex){rowDiv=document.createElement("div"),rowDiv.className="key-row",wrapper.appendChild(rowDiv);var buttonElement,button;row.forEach(function(cfg,index){button=cfg,button.$click=buttonClicked;var attributes=button.attributes||{};if(button.text||button.icon){rowIndex===0&&(index===0?attributes.onLeft||(attributes.onLeft="keyboard-backspace"):index===row.length-1?attributes.onUp||(attributes.onUp="keyboard-backspace",attributes.defaultBackspaceTarget=!0):index===Math.round(row.length/2)&&(attributes.defaultEditTextTarget=!0),attributes.onUp||(attributes.onUp="keyboard-edit-text")),rowIndex===keys.length-1&&(index===1&&(attributes.onDown||(attributes.onDown="keyboard-locale-switcher-btn",attributes.defaultLocaleTarget=!0)),attributes.onDown||(attributes.onDown="keyboard-space-bar")),attributes.onRight=attributes.onRight?attributes.onRight:onRight,attributes.onLeft=attributes.onLeft?attributes.onLeft:onLeft,rowIndex<keys.length-1&&(attributes.onDown||(attributes.onDown=onDown)),rowIndex>0&&(attributes.onUp=onUp),button.attributes=attributes,buttonElement=buttonView(button);switch(button.action){case Constants.SHIFT_ACTION:buttonElement.classList.add("shift"),buttonElement.id="keyboard-shift";break;case Constants.TOGGLE_NUMERIC_ACTION:buttonElement.classList.add("toggle-alpha");break;case Constants.SWITCH_LOCALE_ACTION:buttonElement.classList.add("locale-switcher-btn"),buttonElement.id="keyboard-locale-switcher-btn";var fn=buttonElement.__attached;buttonElement.__attached=function(){fn.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Joystick.UP,function(event){event.eventType&MCDEvent.EventType.Joystick.UP&&(keysState===ALPHA_STATE?alphaWrapper.querySelector("[defaultLocaleTarget]").focusTarget.requestFocus():numericWrapper.querySelector("[defaultLocaleTarget]").focusTarget.requestFocus(),event.stopPropagation())}.bind(this))};break;case Constants.SPACE_ACTION:spaceButton=buttonElement,buttonElement.classList.add("space-bar"),buttonElement.id="keyboard-space-bar";var fn2=buttonElement.__attached;buttonElement.__attached=function(){fn2.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Joystick.UP,function(event){var lastTarget;event.eventType&MCDEvent.EventType.Joystick.UP&&(keysState===ALPHA_STATE?(lastTarget=this.prevTarget,lastTarget?lastTarget.requestFocus():alphaWrapper.querySelector("[defaultSpaceBarTarget]").focusTarget.requestFocus()):(lastTarget=this.prevTarget,lastTarget?lastTarget.requestFocus():numericWrapper.querySelector("[defaultSpaceBarTarget]").focusTarget.requestFocus()),event.stopPropagation())}.bind(this))};break;case Constants.CANCEL_DIALOG_ACTION:buttonElement.id="keyboard-cancel",buttonElement.classList.add("keyboard-cancel");var fn3=buttonElement.__attached;buttonElement.__attached=function(){fn3.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Joystick.UP|MCDEvent.EventType.Wheel.BACK|MCDEvent.EventType.Joystick.LEFT,function(event){if(event.eventType&MCDEvent.EventType.Joystick.UP)keysState===ALPHA_STATE?alphaWrapper.querySelector("[defaultCancelTarget]").focusTarget.requestFocus():numericWrapper.querySelector("[defaultCancelTarget]").focusTarget.requestFocus(),event.stopPropagation();else if(event.eventType&MCDEvent.EventType.Joystick.LEFT||event.eventType&MCDEvent.EventType.Wheel.BACK)keysState===ALPHA_STATE?alphaWrapper.querySelector(".key-row:last-child button:last-child").focusTarget.requestFocus():numericWrapper.querySelector(".key-row:last-child button:last-child").focusTarget.requestFocus(),event.stopPropagation()}.bind(this))};break;case Constants.CLOSE_DIALOG_ACTION:buttonElement.id="keyboard-close",buttonElement.classList.add("keyboard-close");var fn4=buttonElement.__attached;buttonElement.__attached=function(){fn4.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Joystick.UP,function(event){event.eventType&MCDEvent.EventType.Joystick.UP&&(keysState===ALPHA_STATE?alphaWrapper.querySelector("[defaultCloseTarget]").focusTarget.requestFocus():numericWrapper.querySelector("[defaultCloseTarget]").focusTarget.requestFocus(),event.stopPropagation())}.bind(this))}}var attachedCallback=buttonElement.__attached;buttonElement.__attached=function(){attachedCallback.call(this),this.focusTarget.addMCDEventListener(MCDEvent.EventType.Wheel.FORWARD|MCDEvent.EventType.Wheel.BACK,function(event){if(event.eventType&MCDEvent.EventType.Wheel.FORWARD){event.stopPropagation();if(this.focusTarget.onRight){var r;typeof this.focusTarget.onRight=="string"?r=document.getElementById(this.focusTarget.onRight):r=this.focusTarget.onRight(),r&&r.focusTarget&&r.focusTarget.requestFocus()}}if(event.eventType&MCDEvent.EventType.Wheel.BACK){event.stopPropagation();if(this.focusTarget.onLeft){var l;typeof this.focusTarget.onLeft=="string"?l=document.getElementById(this.focusTarget.onLeft):l=this.focusTarget.onLeft(),l&&l.focusTarget&&l.focusTarget.requestFocus()}}}.bind(this))},rowDiv.appendChild(buttonElement)}else rowDiv.appendChild(document.createElement("span"))})}),keys.length===3&&keys[0].length===10?wrapper.className="ten-by-three":keys.length==4&&keys[0].length===12&&(wrapper.className="twelve-by-four")},buildKeyboardByLocale=function(locale){shiftState=LOWER_CASE,currentLocale=locale,currentKeyboard=keyboards[currentLocale];var keys=currentKeyboard.keys;alphas=keys.alphas,numerics=keys.numerics,alphaWrapper.childElementCount&&(alphaWrapper.innerHTML=""),numericWrapper.childElementCount&&(numericWrapper.innerHTML=""),buildKeys(alphas,alphaWrapper,parent),alphaWrapper.classList.add("alpha"),alphaWrapper.querySelector("button").setAttribute("autofocus","autofocus"),buildKeys(numerics,numericWrapper,parent),numericWrapper.classList.add("numeric"),shift(UPPER_CASE);var i18n=currentKeyboard.i18n,spaceText=i18n.space;keyboardWrapper.querySelector("#keyboard-space-bar").setAttribute("text",spaceText)},buildKeyboard=function(parent){keyboardWrapper=document.createElement("div"),keyboardWrapper.className="keyboard scroll";var header=document.createElement("div");header.className="keyboard-header",keyboardWrapper.appendChild(header),header.appendChild(keyboardHeader);var body=document.createElement("div");body.className="keyboard-body",keyboardWrapper.appendChild(body),alphaWrapper=document.createElement("div"),body.appendChild(alphaWrapper),numericWrapper=document.createElement("div"),body.appendChild(numericWrapper);var footer=document.createElement("div");return footer.className="keyboard-footer",keyboardWrapper.appendChild(footer),buildKeys(Constants.FOOTER_KEYS,footer,parent),buildKeyboardByLocale(currentLocale),keyboardWrapper},buildLocaleSwitcher=function(){var div=document.createElement("div");return div.className="locale-switcher",div},reset=function(element){toggleAlpha.call(element),alphaWrapper.querySelector("button[autofocus]").focusTarget.requestFocus()};return function(container){if(container.element.querySelector(".keyboard"))return container.element.querySelector(".keyboard");parent=container,parent.element.classList.add("full-screen");var fragment=document.createDocumentFragment();return fragment.appendChild(buildKeyboard(parent)),fragment.appendChild(buildLocaleSwitcher()),fragment.onShow=function(evt,parent,startingData){window.requestAnimationFrame(function(){startingData!==undefined&&(editText.clear(),editText.type(startingData+""),initialText=startingData+""),reset(container.element),parent.focusController.disableRefresh()})},fragment.onHide=function(){parent.focusController&&parent.focusController.enableRefresh()},fragment}}};return Keyboard});