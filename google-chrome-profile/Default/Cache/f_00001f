define(["require","common/Class","common/Enum","common/Exception","common/Model","common/ObjectUtils","common/lib/ExLax","common/DOMHelper","common/FocusTarget","common/ui/ControlDeprecationMixin","etc/handlebars"],function(require){"use strict";var Class=require("common/Class"),Enum=require("common/Enum"),Exception=require("common/Exception"),Model=require("common/Model"),ObjectUtils=require("common/ObjectUtils"),ExLax=require("common/lib/ExLax"),DOMHelper=require("common/DOMHelper"),FocusTarget=require("common/FocusTarget"),ControlDeprecationMixin=require("common/ui/ControlDeprecationMixin"),Handlebars=require("etc/handlebars"),defineFragmentProperty=function(){(function(){var _this=this,val;this.html||Object.defineProperty(this,"html",{set:function(value){_this.element&&_this.isRendered&&(_this.element.outerHTML=value),val=value},get:function(){return val}})}).bind(this)()},createModel=function(control,isProps){var ModelKlass=Class.create(Model,{validateModelChange:isProps?control.validatePropsChange.bind(control):control.validateModelChange.bind(control)}),model;return model=new ModelKlass({}),model},Control=Class.create(FocusTarget,{Event:undefined,EventType:undefined,Property:undefined,initialize:function($super,attrs,autoRender){autoRender=typeof autoRender=="undefined"?!0:autoRender,this._configs=attrs||{};var modelDefaults=this._getModelDefaults();if(!this.get("model")){for(var def in modelDefaults)if(modelDefaults.hasOwnProperty(def)&&this.get(def)){ControlDeprecationMixin.mixin(this),this._splitPropsFromModel(this._configs,autoRender);break}if(this.get("text")||this.get("value"))ControlDeprecationMixin.mixin(this),this._splitPropsFromModel(this._configs,autoRender)}var tempModel,context=this.get("context");this.get("noFragment")?(this.noFragment=!0,this.deleteProp("noFragment")):this.get("deferFragmentGeneration")&&(this.deferFragmentGeneration=!0,this.deleteProp("deferFragmentGeneration"));if(this.get("id")||this.get("element")){var el=this.get("id")?document.getElementById(this.get("id")):this.get("element");if(el){if(el.getControl)throw new Exception('This control has already been created since you defined a data-oc-control attribute on its DOM element.  You should do this instead: var myControl = Control.getById("'+this.get("id")+'");');el.dataset.ocModel&&(tempModel=context.models[el.dataset.ocModel],tempModel instanceof Model?(tempModel.set(this._configs.model),this._configs.model=tempModel):this._configs.model=ObjectUtils.merge(tempModel,this._configs.model,!0)),el.dataset.ocConfig&&this._setConfigsFromAttribute(el.dataset.ocConfig,context);var thisModel=this.get("model");!this.get("template")&&(!thisModel||!thisModel.text&&(!thisModel.get||!this.model.get("text")))&&el.innerHTML.length&&this.set("template",el.innerHTML),this.existingElement=el,el.removeAttribute("data-oc-control"),el.removeAttribute("data-oc-config"),el.removeAttribute("data-oc-model")}}this._configs instanceof Model?this.controlProps=this._configs:(this.controlProps=createModel(this,!0),this.controlProps.set(this._configs)),typeof this._getControlDefaults=="function"&&this.controlProps.setDefaults(this._getControlDefaults()),delete this._configs,this.get("model")instanceof Model?this.model=this.get("model"):(this.model=createModel(this),this.model.set(this.get("model"))),typeof this._getModelDefaults=="function"&&this.model.setDefaults(this._getModelDefaults()),this.deleteProp("model"),this._onPropsChange.isStub()||this.controlProps.subscribe(Model.Event.EV_CHANGED,this._onPropsChange.bind(this)),this.onModelChange.isStub()||this.model.subscribe(Model.Event.EV_CHANGED,this.onModelChange.bind(this)),this.get("focusable")===undefined&&this.set("focusable",!0),this._setDirectionalOverrides(),$super(this.existingElement||undefined,this.controlProps.getAll()),this.deleteProp("context",!0),this._buildClassNames(),this.controlProps.get("focus")&&(typeof this.controlProps.get("focus")=="function"&&this.addFocusListener(this.controlProps.get("focus")),this.controlProps.remove("focus",!0)),this.controlProps.get("blur")&&(typeof this.controlProps.get("blur")=="function"&&this.addBlurListener(this.controlProps.get("blur")),this.controlProps.remove("blur",!0)),this.controlProps.get("show")&&(typeof this.controlProps.get("show")=="function"&&this.addShowListener(this.controlProps.get("show")),this.controlProps.remove("show",!0)),this.controlProps.get("hide")&&(typeof this.controlProps.get("hide")=="function"&&this.addHideListener(this.controlProps.get("hide")),this.controlProps.remove("hide",!0)),this.noFragment||defineFragmentProperty.call(this);var maxTextLength=this.get("maxTextLength");Handlebars.registerHelper("max_length",function(str){return typeof str!="undefined"&&maxTextLength!==0&&str.length>maxTextLength?str.substring(0,maxTextLength)+"...":str}),this._generateElement.isStub()||(this.existingElement instanceof HTMLElement&&autoRender?this.render():!this.noFragment&&!this.html&&!this.deferFragmentGeneration&&(this.element=this._generateElement(),this.element.isPromise?this.element.done(function(response){this.element=response,this.html=this.element.outerHTML}.bind(this)):(this.element instanceof HTMLElement==0&&(this.element=this.element.element),this.html=this.element.outerHTML)))},render:function(){var parent,args=Array.prototype.slice.apply(arguments),classNames=this.controlProps.get("classNames"),id=this.controlProps.get("id");this.existingElement&&typeof this.existingElement.tagName=="string"?parent=this._renderFromExistingElement.apply(this,args):parent=this._renderNewElement.apply(this,args),this.element.hasAttribute("id")||(this.element.id=id?id:DOMHelper.generateUniqueElementId()),classNames&&(Array.isArray(classNames)?classNames.length&&classNames.forEach(function(className){this.element.classList.add(className)}.bind(this)):this.element.classList.add(classNames)),this.setFocusElement(this.element);for(var k=0,kk=this.children.length,thisChild;k<kk;k++)thisChild=this.children[k],thisChild.isRendered||(thisChild.render(this.element),!this.focusable&&thisChild.focusable&&(this.targetable=!0,this.getFocusController().addFocusableItem(thisChild)));return this._computedStyle=window.getComputedStyle(this.element,null),this.element.getControl=function(){return this}.bind(this),this.element.getModel=function(){return this.model}.bind(this),this._wireHtmlEvents&&this._wireHtmlEvents(parent),this.onPostRender.isStub()||this.onPostRender(parent),this.isRendered=!0,this},remove:function($super){return this.isRendered=!1,$super()},get:function(key){var result;return this.controlProps?key!=="model"&&!this._getControlDefaults().hasOwnProperty(key)&&this.model&&this.model.hasProp(key)?result=ControlDeprecationMixin.get.call(this,key):result=this.controlProps.get(key):this._configs instanceof Model?result=this._configs.get(key):result=this._configs[key],result},set:function(key,val,silent){var prop,props;if(this.controlProps){typeof key=="string"&&((props={})[key]=val);for(prop in props)prop!=="model"&&!this._getControlDefaults().hasOwnProperty(prop)&&this.model&&this.model.hasProp(prop)?ControlDeprecationMixin.set.call(this,prop,props[prop],silent):(silent&&this.controlProps.silent(),this.controlProps.set(prop,props[prop]))}else if(this._configs instanceof Model)silent&&this._configs.silent(),this._configs.set(key,val);else if(typeof key!="object"||typeof val!="boolean"&&typeof val!="undefined")this._configs[key]=val;else for(prop in key)key.hasOwnProperty(prop)&&(this._configs[prop]=key[prop]);return this},hide:function(){return this.previousDisplayState=this.previousDisplayState||this.getComputedStyle("display"),this.element.style.display="none",this.publish(Control.Event.HIDE,this),this},show:function(){return this.element.style.display=this.previousDisplayState||(DOMHelper.getIsInline(this.element)?"inline":"block"),this.publish(Control.Event.SHOW,this),this},toggle:function(){return DOMHelper.isVisible(this.element)?this.hide():this.show(),this},isVisible:function(){return this.element&&DOMHelper.isVisible(this.element)},onModelChange:function(evt,type,prop,newValue,oldValue){throw new Exception("onModelChange is abstract",Exception.ErrorCode.UNIMPLEMENTED_METHOD)}.stub(),isDisabled:function(){return this.get("disabled")},setDisabled:function(disabled){this.set("disabled",disabled)},getTagName:function(){return this.get("tagName")||this.element.tagName},setClasses:function(classes){var oldClasses=this.get("classNames"),addClass=function(newClass){oldClasses.indexOf(newClass)===-1&&(oldClasses.push(newClass),this.element.classList.add(newClass))}.bind(this);arguments.length>1?classes=Array.prototype.slice.apply(arguments):typeof classes=="string"&&(classes=[classes]);for(var i=0,ii=classes.length;i<ii;i++)addClass(classes[i]);return this},removeClasses:function(classes){var oldClasses=this.get("classNames"),removeClass=function(newClass){var index=oldClasses.indexOf(newClass);index>-1&&(oldClasses.splice(index,1),this.element.classList.remove(newClass))}.bind(this);arguments.length>1?classes=Array.prototype.slice.apply(arguments):typeof classes=="string"&&(classes=[classes]);for(var i=0,ii=classes.length;i<ii;i++)removeClass(classes[i]);return this},getById:undefined,getConfigCallbacks:function(){return["click","longClick","onLeft","onRight","onUp","onDown","focus","blur","show","hide"]},_setConfigsFromAttribute:function(value,context){var obj=JSON.parse(value),callbackProps=this.getConfigCallbacks();for(var prop in obj)obj.hasOwnProperty(prop)&&callbackProps.indexOf(prop)>-1&&typeof obj[prop]=="string"&&((!context||!context[obj[prop]]||typeof context[obj[prop]]!="function")&&Exception.buildIllegalArgumentException("You either haven't defined your callback context, or it's not a function."),obj[prop]=context[obj[prop]].bind(context));this.set(obj)},_setDirectionalOverrides:function(){var onLeft=this.get("onLeft"),onRight=this.get("onRight"),onUp=this.get("onUp"),onDown=this.get("onDown");typeof onLeft!="undefined"&&(this.onLeft=onLeft,this.controlProps.silent().remove("onLeft")),typeof onRight!="undefined"&&(this.onRight=onRight,this.controlProps.silent().remove("onRight")),typeof onUp!="undefined"&&(this.onUp=onUp,this.controlProps.silent().remove("onUp")),typeof onDown!="undefined"&&(this.onDown=onDown,this.controlProps.silent().remove("onDown"))},_onPropsChange:function(evt,type,prop,newValue,oldValue){var checks="onRight|onLeft|onUp|onDown".split("|");checks.indexOf("prop")>-1?this[prop]=newValue:prop==="template"?this._buildHtmlFromTemplate():prop==="maxTextLength"&&(this.get("template")&&Handlebars.registerHelper("max_length",function(str){return newValue!==0&&str.length>newValue?str.substring(0,newValue)+"...":str}),this._renderModelToHtml())},validatePropsChange:function(prop,newValue,oldValue){return newValue},validateModelChange:function(prop,newValue,oldValue){return newValue},_generateElement:function(){throw new Exception("_generateElement is abstract",Exception.ErrorCode.UNIMPLEMENTED_METHOD)}.stub(),onPostRender:function(parent){throw new Exception("onPostRender is abstract",Exception.ErrorCode.UNIMPLEMENTED_METHOD)}.stub(),getElementAttributes:function(attrs){var values={};arguments.length>1?attrs=Array.prototype.slice.apply(arguments):Array.isArray(attrs)||(attrs=[attrs]);if(this.element)for(var i=0,ii=attrs.length,attrName,eleValue;i<ii;i++)attrName=attrs[i],eleValue=this.element[attrName]||this.element.getAttribute(attrName),typeof eleValue!="undefined"&&eleValue!==null&&eleValue!==""&&(values[attrName]=eleValue);return values},deleteProp:function(key,silent){return this.controlProps?!this.controlProps.hasProp(key)&&this.model&&this.model.hasProp(key)?ControlDeprecationMixin.remove.call(this,key,silent):(silent&&this.controlProps.silent(),this.controlProps.remove(key)):this._configs instanceof Model?(silent&&this._configs.silent(),this._configs.remove(key)):delete this._configs[key],this},setStyle:function(props,merge){return DOMHelper.setStyle(this.element,Array.prototype.slice.apply(arguments)),this},animate:function(duration,delay,props,ease,callback){return ExLax.to(this.element,duration,delay,props,callback)},setId:function(id){return typeof id=="string"&&id.length&&(document.getElementById(id)?Log.warn("There's already an element with the ID "+id+" in your app."):(this.set("id",id),this.element.id=id)),this},getComputedStyle:function(prop){return typeof prop!="string"?this._computedStyle:this._computedStyle.getPropertyValue(prop)},_unbind:function(){var newEl=this.element.cloneNode();return newEl.getControl=null,newEl.focusTarget=null,newEl.getModel=null,this.element.parentNode.replaceChild(newEl,this.element),this.remove(),newEl},addModel:function(model){var tmp;model instanceof Model==0&&(tmp=createModel(this),tmp.set(model),model=tmp),this.model=model,this.model.setDefaults(this._getModelDefaults()),this.element=this._generateElement(this.getParentElement()),this.render(this.getParentElement())},_getModelDefaults:function(){return{}},_getControlDefaults:function(){return{tagName:undefined,id:undefined,classNames:undefined,noStyle:undefined,template:undefined,onLeft:undefined,onRight:undefined,onUp:undefined,onDown:undefined,click:undefined,longClick:undefined,focus:undefined,blur:undefined,disabled:undefined,focusable:undefined,targetable:undefined,noFragment:undefined,deferFragmentGeneration:undefined,constraintParent:undefined,maxTextLength:30}},_renderModelToHtml:function(element){!element&&this.renderedElement&&(element=this.renderedElement),this.renderedElement=element;if(this.get("template"))this._buildHtmlFromTemplate(element);else{var text=this.model.get("text")||"",existingSpan=element.querySelector(".item-text");if(existingSpan){var existingText=existingSpan.textContent;existingText!==text&&(existingSpan.textContent=text)}else{var span=document.createElement("span");span.classList.add("item-text");var rawStr=text.substr(0,this.get("maxTextLength"));rawStr.indexOf("&")!=-1?span.innerHTML=rawStr:span.appendChild(document.createTextNode(rawStr)),element.appendChild(span)}}},_renderModelToHtmlLegacy:function(element){!element&&this.renderedElement&&(element=this.renderedElement),this.renderedElement=element;if(this.get("template"))this._buildHtmlFromTemplate(element);else{var text=this.model.get("text")||"";element.innerHTML=text.substr(0,this.get("maxTextLength"))}},_buildHtmlFromTemplate:function(element){if(element instanceof HTMLElement==0)throw new Exception("You must pass this function an element as its one argument",Exception.ErrorCode.ILLEGAL_ARGUMENTS);this.template=Handlebars.compile(this.get("template")),this._renderContentsFromTemplate(element)},_renderContentsFromTemplate:function(element){element=element||this.element,this.template&&(element.innerHTML=this.template(this.model.flatten()))},_buildClassNames:function(){var classList,classNames=this.controlProps.get("classNames")||[];typeof classNames=="string"&&(classNames=[classNames]);if(this.existingElement){classList=this.existingElement.classList;if(classList.length!==0)for(var i=0,ii=classList.length,className;i<ii;i++)className=classList[i],classNames.indexOf(className)===-1&&classNames.push(className)}this.controlProps.silent().set("classNames",classNames)},_reuseElement:function(){return this.model.get("text")||this.get("template")?this._renderModelToHtml(this.existingElement):(this.set("template",this.existingElement.innerHTML,!0),this._buildHtmlFromTemplate(this.existingElement)),this.existingElement},_getRenderParent:function(){var parent;return typeof arguments[0]!="undefined"?arguments[0]instanceof HTMLElement||arguments[0]instanceof DocumentFragment?parent=arguments[0]:arguments[0]instanceof FocusTarget?parent=arguments[0].getFocusElement():parent=document.getElementById(arguments[0]):this.existingElement&&this.existingElement.parentElement?parent=this.existingElement.parentElement:this.getParentFocusTarget()&&(parent=this.getParentFocusTarget().getFocusElement()),parent},_renderFromExistingElement:function(){var parent,attrs,existingClasses;this.existingElement&&this.existingElement.parentElement?parent=this.existingElement.parentElement:parent=this._getRenderParent.apply(this,Array.prototype.slice.apply(arguments));if(!parent||typeof parent.tagName!="string")throw new Exception("No acceptable parent to render control into.",Exception.ErrorCode.ILLEGAL_ARGUMENTS);this.element=this._reuseElement(parent),this.html=this.element.outerHTML;if(this._noReuse){attrs=this.existingElement.attributes;for(var i=0,ii=attrs.length,attr;i<ii;i++){attr=attrs.item(i);if(attr.name==="class"){existingClasses=this.existingElement.classList;for(var j=0;j<existingClasses.length;j++)this.element.classList.add(existingClasses[j])}else this.element.setAttribute(attr.nodeName,attr.nodeValue)}try{parent.replaceChild(this.element,this.existingElement)}catch(e){Log.warn("DOM Error caught replacing element..."+e)}}return delete this.existingElement,parent},_renderNewElement:function(){var parent=this._getRenderParent.apply(this,Array.prototype.slice.apply(arguments));if(!parent)throw new Exception("No acceptable parent to render control into.",Exception.ErrorCode.ILLEGAL_ARGUMENTS);if(!this.element||this.noFragment){if(this._generateElement.isStub())throw new Exception("_generateElement is abstract. You need to override it.",Exception.ErrorCode.UNIMPLEMENTED_METHOD);this.element=this._generateElement(parent),this.element instanceof HTMLElement==0&&(this.element=this.element.element),this.html=this.element.outerHTML}if(!this.element)throw new Exception("Unable to render control as no output was produced by the _generateElement method.",Exception.ErrorCode.ILLEGAL_ARGUMENTS);return parent.appendChild(this.element),parent},addShowListener:function(listener){return this.subscribe(Control.Event.SHOW,listener)},removeShowListener:function(listener){return this.unsubscribe(Control.Event.SHOW,listener)},addHideListener:function(listener){return this.subscribe(Control.Event.HIDE,listener)},removeHideListener:function(listener){return this.unsubscribe(Control.Event.HIDE,listener)}});return Control.getById=function(domId){var control,el=document&&document.getElementById(domId);return el&&(control=el.getControl()),control},Control.Event=new Enum({VALUE_CHANGED:"/ui/control/value/changed",SHOW:"/ui/control/show",HIDE:"/ui/control/hide"}),Control});