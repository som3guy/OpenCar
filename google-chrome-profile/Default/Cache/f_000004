define(["require","common/Logging","platform/worker/api/TelematicsProvider","utils","telematics","video-popout","playback","jqueryui"],function(require){"use strict";window.Log=require("common/Logging");var Provider=require("platform/worker/api/TelematicsProvider"),Utils=require("utils"),Telematics=require("telematics"),VideoPopout=require("video-popout"),Playback=require("playback"),$=require("jqueryui"),profileNames,profiles=[],programNames,programs=[],currentProgram,currentProfile,documentReady=$.Deferred(),fetchCurrentVehicleProfileName=$.Deferred(),fetchVehicleProfiles=$.Deferred(),fetchVehiclePrograms=$.Deferred(),providerInit=$.Deferred(),isLoopOn=!1,xenoRetries=0;Playback.setVideoPopout(VideoPopout),$(document).ready(function(){documentReady.resolve()}),$.getJSON("/profile/getprogramlist",function(resp){programNames=resp.ResultSet.ProgramList,programNames.length===0?(Utils.showProgramError(),console.error("No programs found. Check ~/OpenCar/programs/")):($.each(programNames,function(i){getProgramInfo(programNames[i])}),$.getJSON("/profile/getprogram",function(resp){resp.ResultSet.Name===""?setProgramToFirst():(currentProgram=resp.ResultSet.Name,console.log("Current program:",currentProgram),Utils.saveData("current-program",currentProgram),Utils.saveData("current-profile",currentProgram),profileNames=[currentProgram],$.getJSON("../vehicle-profiles/$PRG$/"+currentProgram+"/programInfo.json",function(resp){getProfileInfo(resp.profile),fetchCurrentVehicleProfileName.resolve()}).fail(function(jqxhr,textStatus,error){setProgramToFirst()}))}).fail(function(jqxhr,textStatus,error){Utils.showProgramError(),console.error("No programs found. Check ~/OpenCar/programs/"),console.error(error)}))}).fail(function(jqxhr,textStatus,error){Utils.showProgramError(),console.error("No programs found. Check ~/OpenCar/programs/"),console.error(error)});function setProgramToFirst(){console.log("No program is set, selecting a program to set."),Utils.setProgram(programs[0].name),currentProgram=programs[0].name,currentProfile=programs[0].profile,Utils.saveData("current-profile",currentProfile),profileNames=[currentProfile],getProfileInfo(currentProfile),fetchCurrentVehicleProfileName.resolve()}function getProfileInfo(profileName){$.getJSON("../vehicle-profiles/"+profileName+"/profileInfo.json",function(info){info.name=profileName,info.type="profile",info.url||(info.url="/ui/"),profiles.push(info),profiles.length===profileNames.length&&fetchVehicleProfiles.resolve()}).fail(function(jqxhr,textStatus,error){console.error("Failed to fetch profileInfo.json for:",profileName),console.error(error)})}function getProgramInfo(programName){$.getJSON("../vehicle-profiles/$PRG$/"+programName+"/programInfo.json",function(info){info.name=programName,info.type="program",info.url||(info.url="/ui/"),$.getJSON("../user/programs/"+info.name+"/ux-profile/"+info.profile+"/profileInfo.json",function(resp){info.profileDetails=resp}).fail(function(jqxhr,textStatus,error){console.error(error)}),programs.push(info),programs.length===programNames.length&&fetchVehiclePrograms.resolve()}).fail(function(jqxhr,textStatus,error){console.error("Failed to fetch programInfo.json for:",programName),console.error(error)})}Provider.init().done(function(){providerInit.resolve()}),initVideoTag(),$.when(documentReady,fetchCurrentVehicleProfileName,fetchVehicleProfiles,fetchVehiclePrograms,providerInit).done(function(){Utils.loadData("notLoadedBefore")!="true"?Utils.showWelcome():initUI()});function initUI(){Utils.getTutorialAppList(),Utils.getExamplesAppList(),Utils.getWorkspaceAppList(),Utils.setProfileListHeight(),Utils.setSidebarHeight(),Utils.setReferenceDocHeight(),Utils.setFloaterContainer(),Utils.setConsoleHeight(),$("#launch-tabs > ul").show(),$("#launch-tabs").tabs(),$("ul.profile-picker li > ul").slideUp(100),$("ul.launch-picker li > div").slideUp(100),$("ul.drive-picker li > ul").slideUp(100),$("#container").animate({opacity:1},300),$("#sidebar-button").click(function(){$(".content-margin").css("marginRight")=="0px"?Utils.showSidebar():Utils.hideSidebar()});var programsHash={};function getProfileName(a,b){var preurl="/ui/user/programs/"+a+"/ux-profile/",def=$.Deferred(),getProm=$.getJSON(preurl+b+"/profileInfo.json",function(resp){console.warn("Profile Info: "+resp.display)}).fail(function(jqxhr,textStatus,error){console.error(error)});return getProm.then(function(data){var results=data.display;def.resolve(results)}),def.promise()}var l=programs.length,n=0;$.each(programs,function(i){var programHash={},programPickerRow="",programID=programs[i].uid,preurl="/ui/user/programs/"+programID+"/simulator-plugins/";programsHash[programs[i].name]=programs[i],programHash=programsHash[programs[i].name];var profileName=getProfileName(programs[i].uid,programs[i].profile);profileName.done(function(result){console.log(programs[i]),programPickerRow="",programPickerRow+='<li id="'+programID+'" class="program-info clearfix">',programPickerRow+='<div class="program-icon"><img src="../user/programs/'+programs[i].name+"/ux-profile/"+programs[i].profile+'/img/simulator-icon.png" /></div>',programPickerRow+="<h1>"+programs[i].display+"</h1>",programPickerRow+='<a href="#" class="program-more plus"></a>',programPickerRow+='<div class="profile-more-info hide">',programPickerRow+="<h2><span>UX Profile:</span> "+result+"</h2>",programPickerRow+="<h2><span>Capabilities:</span> "+programs[i].capabilities+"</h2>",programs[i].profileDetails&&(programPickerRow+="<h2><span>Resolution:</span> "+programs[i].profileDetails.screen.width+"w x "+programs[i].profileDetails.screen.height+"h</h2>"),programPickerRow+="<h2><span>Simulator Plugins:</span></h2>",programPickerRow+='<ul class="plugins-list">',$.each(programs[i].plugins,function(i,data){$.getJSON(preurl+data+"/plugin.json",function(resp){$("<li>"+resp.display+"</li>").appendTo("#"+programID+" .plugins-list")}).fail(function(jqxhr,textStatus,error){console.error(error)})}),programPickerRow+="</ul>",programPickerRow+='<img src="../user/programs/'+programs[i].name+"/ux-profile/"+programs[i].profile+'/img/simulator-preview.png" />',programPickerRow+="</div>",programPickerRow+="</li>",$(programPickerRow).appendTo("#profile-list-items"),$("#"+programID+" h1").on("click",function(){console.log("*********************** Switching Program to "+programs[i].name+" ***********************"),switchProgramProfile(programHash,programs[i].profile,programs[i].url,programs[i].display,result)}),n++,l===n&&doSwitchProgramProfileNow()})});function doSwitchProgramProfileNow(){var currentProgramName=Utils.loadData("current-program"),currentProgram;if(!currentProgramName||typeof programsHash[currentProgramName]=="undefined")console.error("No valid profile data found for "+currentProgramName),currentProgramName=programs[0].name;currentProgram=programsHash[currentProgramName];var currentProfileName=getProfileName(currentProgram.uid,currentProgram.profile);currentProfileName.done(function(result){switchProgramProfile(programsHash[currentProgramName],currentProgram.profile,currentProgram.url,currentProgram.display,result)}),$(".program-more").click(function(){$(this).siblings(".profile-more-info").hasClass("hide")?($(this).removeClass("plus").addClass("minus"),$(this).siblings(".profile-more-info").removeClass("hide").addClass("show")):($(this).addClass("plus").removeClass("minus"),$(this).siblings(".profile-more-info").removeClass("show").addClass("hide"))}),Utils.loadData("drive-file-play-index")&&$("#drive-controls").show()}}function switchProgramProfile(program,profile,iFrameContent,display,profileDisplayName){Utils.getCurrentApp(),Utils.resetUI(),Utils.setProgram(program.uid),jQuery.support.cors=!0,$.ajax({url:"http://simulator.opencar.com/index.php",data:{profile:profileDisplayName,program:program.name},type:"GET",timeout:3e4,dataType:"text",success:function(data){$("#simulator-frame").attr("src","http://simulator.opencar.com/index.php?profile="+profileDisplayName+"&program="+program.display).show()},error:function(jqXHR,textStatus,ex){$("#simulator-frame").attr("src","").hide()}});var sidebarOpen=window.parseInt($("#sidebar").css("right"),10)>=0;$.getJSON("/profile/setVehicle?name="+profile,function(resp){parseInt(resp.ResultSet.ResponseCode)===0?(console.log("Setting vehicle profile in Xeno to:",profile),$(".control-window ").stop().fadeOut(100),$("#screen").stop().fadeOut(100),$("#bezel").stop().fadeOut(100,function(){$("#tab-icons").stop().animate({right:"-44px"},300,function(){$("#tabs").stop().animate({left:"400px"},300,function(){sidebarOpen||Utils.showSidebar()})})}),setTimeout(function(){$("#current-profile").text(display);var pfx="/ui/vehicle-profiles/$SIM$/";console.log("Load Simulator Plugins:");var n=0;$.each(program.plugins,function(i){n++,$.getJSON(pfx+program.plugins[i]+"/plugin.json",function(resp){var plug=program.plugins[i];$.each(resp.types,function(i){switch(resp.types[i]){case"bezel-art":console.log(program.plugins[i],"bezel-art"),Utils.setBezelArt(pfx+plug+"/bezel-art.css"),$("ul.profile-picker > li > a").css("background-image","url(/ui/vehicle-profiles/$UX$/"+profile+"/img/simulator-icon.png)");break;case"bezel-controls":var css=pfx+plug+"/bezel-controls.css",html=pfx+plug+"/bezel-controls.html",js=pfx+plug+"/bezel-controls.js",tabs=pfx+plug+"/bezel-icons.html";Utils.setBezelControls(css,html,js,tabs,profile),console.log(program.plugins[i],"bezel-controls");break;case"floater-controls":var css=pfx+plug+"/floater-controls.css",html=pfx+plug+"/floater-controls.html",js=pfx+plug+"/floater-controls.js",tabs=pfx+plug+"/floater-icons.html";Utils.setFloaterControls(css,html,js,tabs,profile),console.log(program.plugins[i],"floater-controls");break;case"vehicle-data":console.log(plug,"vehicle-data"),Telematics.buildTelematicsMenus(plug,pfx+plug+"/tmx/TelematicsOcids.js");break;default:console.error("plugin.json must list at lease one type")}})}).fail(function(jqxhr,textStatus,error){console.error("Could not get plugin.json for",program.plugins[i]),console.error(error)})})},400),driveReset(!0,program.uid),Playback.bindOnDriveReset(driveReset.bind(null,!1)),setTimeout(function(){program.profileDetails&&(console.log("#screen width:",program.profileDetails.screen.width),console.log("#screen height:",program.profileDetails.screen.height),Utils.resizeScreen(program.profileDetails.screen.width,program.profileDetails.screen.height)),Utils.setIFrame(iFrameContent),$("#screen").stop().fadeIn(100),$("#bezel").stop().fadeIn(100),makeControlIconsActive()},800)):console.error(resp.ResultSet.ResponseText)}).error(function(jqxhr,textStatus,error){console.error("Error trying to setVehicle profile."),console.error(error)})}$(window).resize(function(){Utils.setProfileListHeight(),Utils.setSidebarHeight(),Utils.setReferenceDocHeight(),Utils.setFloaterContainer(),Utils.setConsoleHeight()}),$("ul.picker li").hover(function(){$(this).children("ul").stop().slideDown(200)},function(){$(this).children("ul").stop().slideUp(200)}),$("ul.launch-picker li").hover(function(){$(this).children("div").stop().slideDown(200)},function(){$(this).children("div").stop().slideUp(200)}),$("#close-docs").click(function(){}),$("#docs-link").click(function(){}),$("#ivi-reload").click(function(){$("#screen")[0].contentWindow.location.reload()}),$("#go").click(function(){Utils.saveData("notLoadedBefore",!0),Utils.hideWelcome(),initUI()}),$("#help-hardware-emulation").hover(function(){$("#feature-hardware-emulation").fadeIn(300)},function(){$("#feature-hardware-emulation").fadeOut(300)}),$("#help-vehicle-profiles").hover(function(){$("#feature-vehicle-profiles").fadeIn(300)},function(){$("#feature-vehicle-profiles").fadeOut(300)}),$("#help-telematics").hover(function(){$("#feature-telematics").fadeIn(300)},function(){$("#feature-telematics").fadeOut(300)}),$("#help-drive-playback").hover(function(){$("#feature-drive-playback").fadeIn(300)},function(){$("#feature-drive-playback").fadeOut(300)});function checkDocumentationSupport(){var documentationButtonDOM=document.getElementById("docs-link");$.getJSON("assets/docs/data.json",function(){documentationButtonDOM.style.display=""}).fail(function(jqxhr,textStatus,error){console.log("No documents found, hiding the UI for documents.")})}function makeControlIconsActive(){$(".bezel-control-icon").on("click",function(){var id=$(this).attr("control-id");$(this).hasClass("ui-state-active")?($(this).removeClass("ui-state-active"),$("#"+id).removeClass("show").addClass("hide"),Utils.saveData(id,!0)):($(this).addClass("ui-state-active"),$("#"+id).removeClass("hide").addClass("show"),Utils.saveData(id,!1))}),$(".close-box").click(function(){var floaterId=$(this).parent(".control-window").attr("id");$(".floater-control-icon[control-id="+floaterId+"]").removeClass("ui-state-active"),$("#"+floaterId).removeClass("show").addClass("hide"),Utils.saveData(floaterId,!0)}),$.each($(".floater-control-icon"),function(i){var controlId=$(this).attr("control-id");$("#"+controlId).draggable({containment:"#floater-container",cursor:"move",handle:".drag-handle",stop:function(event,ui){var cpos=$("#"+controlId).position();Utils.saveData(controlId+"-x",cpos.left),Utils.saveData(controlId+"-y",cpos.top)},zIndex:700,iframeFix:!0,stack:".floater"}),$($(this)).on("click",function(){if($(this).hasClass("ui-state-active"))$(this).removeClass("ui-state-active"),$("#"+controlId).removeClass("show").addClass("hide"),Utils.saveData(controlId,!1);else{$(this).addClass("ui-state-active");var cposx=Utils.loadData(controlId+"-x"),cposy=Utils.loadData(controlId+"-y");cposx&&$("#"+controlId).css("left",cposx+"px"),cposy&&$("#"+controlId).css("top",cposy+"px"),$("#"+controlId).removeClass("hide").addClass("show"),Utils.saveData(controlId,!0)}});if(Utils.loadData(controlId)=="true"){$(this).addClass("ui-state-active");var cposx=Utils.loadData(controlId+"-x"),cposy=Utils.loadData(controlId+"-y");cposx&&$("#"+controlId).css("left",cposx+"px"),cposy&&$("#"+controlId).css("top",cposy+"px"),$("#"+controlId).removeClass("hide").addClass("show")}else $(this).removeClass("ui-state-active"),$("#"+controlId).removeClass("show").addClass("hide")})}var playIcon="M 8 9 L 24.5 16.5 L 8 24 L 8 9 Z",pauseIcon="M 19 9 L 19 24 L 22 24 L 22 9 L 19 9 ZM 10 9 L 10 24 L 13 24 L 13 9 L 10 9 Z",down=!1,minTime,maxTime,curTime,clockHandle;function initVideoTag(){var v=$("#drive-file-video").get(0);v.toggleVisibility=function(state){if(state===undefined)return;var embeddedWindowLayoutElem=$("#drive-file-window");if(state===!0){var cposx=Utils.loadData("video-window-x"),cposy=Utils.loadData("video-window-y");cposx&&embeddedWindowLayoutElem.css("left",cposx+"px"),cposy&&embeddedWindowLayoutElem.css("top",cposy+"px"),Playback.showEmbeddedMovieWindow()}else Playback.hideEmbeddedMovieWindow()}}function driveReset(autoloadSelectedDriveFlag,currentProgram){Playback.getAvailableDriveFiles(autoloadSelectedDriveFlag,currentProgram,function(ok){ok?(Utils.loadData("video-window-show")===!0&&Playback.showEmbeddedMovieWindow(),down=!1,maxTime=curTime=0,stopCountingTime(0),updateProgressBarDisplay(),$("#drive-play-pause .icon-color").attr("d",playIcon),Playback.pause(function(){Playback.getStatus(function(statusInfo){statusInfo&&statusInfo.maxTime&&(minTime=statusInfo.curTime,curTime=statusInfo.curTime,maxTime=statusInfo.maxTime,updateProgressBarDisplay())})})):(Playback.pause(),Playback.hideEmbeddedMovieWindow())})}function setScrubPosition(e){if(down){stopCountingTime(curTime);var scrubAreaElem=$("#drive-file-scrub-area"),scrubberIndicatorWidth=$("#drive-file-scrubber").get(0).offsetWidth,p=e.clientX+scrubberIndicatorWidth/2,left=scrubAreaElem.get(0).getBoundingClientRect().left,pct=(p-left)*100/scrubAreaElem.width();if(pct<0||p-left<scrubberIndicatorWidth)pct=0;pct>100&&(pct=100),curTime=Math.max(maxTime*pct/100,minTime),Playback.setDriveFilePosition(curTime,function(ok){ok&&updateProgressBarDisplay()})}}function togglePlayPause(){if(!Playback.getCurrentDriveMetadata()){console.log("no drive play selected");return}Playback.getStatus(function(statusInfo){var pptext;statusInfo&&!statusInfo.paused?pptext=pauseIcon:pptext=playIcon;var playPauseIcon=$("#drive-play-pause .icon-color");playPauseIcon.attr("d",pptext);if(statusInfo&&statusInfo.maxTime){if(xenoRetries<2&&statusInfo.paused&&Math.abs(curTime-statusInfo.curTime)>1e3){xenoRetries++,setTimeout(function(){togglePlayPause()},400);return}xenoRetries=0,curTime=statusInfo.curTime,maxTime=statusInfo.maxTime,updateProgressBarDisplay(),statusInfo.paused?curTime>=maxTime&&isLoopOn?(curTime=minTime,Playback.setDriveFilePosition(curTime,function(ok){togglePlayPause();return})):Playback.play(function(isPlaying){isPlaying&&($("#drive-play-pause .icon-color").attr("d",pauseIcon),startCountingTime(statusInfo.curTime))}):Playback.pause(function(isPaused){isPaused&&(playPauseIcon.attr("d",playIcon),stopCountingTime(statusInfo.curTime))})}})}function updateTimeDisplay(){var t=curTime,hrs=t/36e5,min=hrs%1*60,sec=min%1*60;function zeroPad(n,width,z){return z=z||"0",n=Math.floor(n)+"",n.length>=width?n:(new Array(width-n.length+1)).join(z)+n}var timeFormatted=[hrs>1?Math.floor(hrs):null,zeroPad(min,2),zeroPad(sec,2)].filter(function(val){return val!==null}).join(":");$("#drive-time-pos").text(timeFormatted)}function updateProgressBarDisplay(){var pct=maxTime?curTime*100/maxTime:0,isEnd=!1;return pct>=100&&(pct=100,isEnd=!0,Playback.pause(function(isPaused){isPaused&&($("#drive-play-pause .icon-color").attr("d",playIcon),stopCountingTime(maxTime))})),$("#drive-file-position").css("width",pct+"%"),updateTimeDisplay(),isEnd}function startCountingTime(ms){var timeIncrement=100;stopCountingTime(ms),clockHandle=setInterval(function(){curTime+=timeIncrement;var isEnd=updateProgressBarDisplay();Playback.updateTelematicsOverlayData(curTime),isEnd&&isLoopOn&&(curTime=minTime,Playback.setDriveFilePosition(curTime,function(ok){ok&&togglePlayPause()}))},timeIncrement)}function stopCountingTime(ms){curTime=ms,clearInterval(clockHandle)}$("#drive-file-scrub-area").mousedown(function(e){down=!0,Playback.pause(function(isPaused){isPaused&&($("#drive-play-pause .icon-color").attr("d",playIcon),setScrubPosition(e))})}),$("#drive-file-scrub-area").mouseup(function(e){down=!1}),$("#drive-file-scrub-area").mousemove(function(e){setScrubPosition(e)}),$("#drive-play-pause").click(function(e){togglePlayPause()}),$("#drive-file-scrub-area").mouseleave(function(){down===!0&&(down=!1)}),$("#drive-file-window").draggable({containment:"#floater-container",cursor:"move",handle:".drag-handle",stop:function(event,ui){Utils.saveData("video-window-x",ui.position.left),Utils.saveData("video-window-y",ui.position.top)},zIndex:700,iframeFix:!0,stack:".floater"}),$("#playback-movie").click(function(){var internalVal=Utils.loadData("video-window-show"),toggledState=internalVal==="false"||internalVal==="undefined"||internalVal===undefined;Utils.saveData("video-window-show",toggledState),Playback.toggleMovieWindow(toggledState)}),$("#playback-loop").click(function(){isLoopOn=!isLoopOn,$("#playback-loop").toggleClass("ui-state-active",isLoopOn)}),$("#drive-file-window .close-box").click(function(){Playback.setVideoTargetWindowMode(Playback.videoTargetWindowModeType.EMBEDDED),Playback.toggleMovieWindow(!1),Playback.setVideoTargetWindow(window);var player=Playback.getVideoTargetPlayer();if(player&&player.paused)return;var oldMaxTime=maxTime;maxTime=curTime=0,stopCountingTime(0),updateProgressBarDisplay();var driveData=Playback.getCurrentDriveMetadata();driveData&&(maxTime=oldMaxTime,driveData.playCount>0&&togglePlayPause())}),$("#drive-file-window .drive-telematics-button").click(function(e){var target=$(this),toggleClass="active",toggleState=!target.hasClass(toggleClass);target.toggleClass(toggleClass,toggleState),Playback.toggleTelematicsOverlay(toggleState)}),$("#drive-file-window .popout-button").click(VideoPopout.onLaunchPlayerEvent.bind(VideoPopout)).hover(function(e){$(this).toggleClass("hover")}),Playback.setVideoTargetWindowMode(Playback.videoTargetWindowModeType.EMBEDDED),Utils.loadData("video-window-show")=="true"&&Utils.loadData("drive-file-play-index")&&Playback.toggleMovieWindow(!0)});