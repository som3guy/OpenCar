define(["require","common/Class","common/Model","common/ObjectUtils","common/MCDEvent","common/DOMHelper","common/ui/Control","common/ui/TextView","common/ui/ListItemView","common/Exception","common/ArrayList","common/lib/Promise","common/ui/mixin/ListViewMixin","common/ui/mixin/VerticalGridViewMixin","common/ui/mixin/CenteredListViewMixin","common/lib/SFX","hammer"],function(require){"use strict";var Class=require("common/Class"),Model=require("common/Model"),ObjectUtils=require("common/ObjectUtils"),MCDEvent=require("common/MCDEvent"),DOMHelper=require("common/DOMHelper"),Control=require("common/ui/Control"),TextView=require("common/ui/TextView"),ListItemView=require("common/ui/ListItemView"),Exception=require("common/Exception"),ArrayList=require("common/ArrayList"),Promise=require("common/lib/Promise"),ListViewMixIn=require("common/ui/mixin/ListViewMixin"),GridViewMixIn=require("common/ui/mixin/VerticalGridViewMixin"),CenteredListViewMixIn=require("common/ui/mixin/CenteredListViewMixin"),SFX=require("common/lib/SFX"),Hammer=require("hammer"),eventNames="panup pandown panend panstart",ListView=Class.create(Control,{hasOwnWheelFocus:!0,_noReuse:!0,initialize:function($super,attrs,autoRender){this._configs=attrs||{},this._configs.model===undefined&&(this._configs.model={arrayList:this._configs.arrayList||new ArrayList([])}),this.__animating=!1,this.__ignoreKeys=!1,this.__animatingRefCount=0,this._idleCallbacks=[];var itemChanged=this.get("itemChanged"),itemSelected=this.get("itemSelected"),beforeChange=this.get("beforeChange"),pastLast=this.get("pastLast"),beforeFirst=this.get("beforeFirst");itemChanged&&typeof itemChanged=="function"&&(this.addItemChangedListener(itemChanged),this.deleteProp("itemChanged")),itemSelected&&(typeof itemSelected=="function"&&this.addItemSelectedListener(itemSelected),this.deleteProp("itemSelected")),beforeChange&&(typeof beforeChange=="function"&&this.addBeforeChangeListener(beforeChange),this.deleteProp("beforeChange")),pastLast&&(typeof pastLast=="function"&&this.addPastLastListener(pastLast),this.deleteProp("pastLastListener")),beforeFirst&&(typeof beforeFirst=="function"&&this.addBeforeFirstListener(beforeFirst),this.deleteProp("beforeFirst")),this.setBaseListeners(this._configs instanceof Model?this._configs.getAll():this._configs),this.itemClickListeners=[],this.itemLongClickListeners=[],typeof this.get("initialIndex")!="undefined"&&(this.initialIndex=this.get("initialIndex")),this.mixinMode(this.get("mode")?this.get("mode"):this.getDefaultMode()),typeof attrs.showTitle!="undefined"?this._configs.showTitle=attrs.showTitle:this._configs.showTitle=!0,$super(this._configs,autoRender),this.set("selectedIndex",0),this.getArrayList().selectedIndex=0,this.modelChangeMethod=this.onModelChange.bind(this),setupArrayList.call(this),(this.get("itemsPerPage")<0||this.get("itemsPerPage")!==Math.round(this.get("itemsPerPage")))&&this.set("itemsPerPage",200,!0),this._currentPage=0,this.get("itemClick")&&this.itemClickListeners.push(this.get("itemClick")),this.get("itemSelectedClick")&&this.addSelectedItemClickedListener(this.get("itemSelectedClick")),this.get("itemLongClick")&&this.itemLongClickListeners.push(this.get("itemLongClick")),this.addMCDEventListener(MCDEvent.EventType.Joystick.FIRE|MCDEvent.EventType.Joystick.FIRE_AND_HOLD|MCDEvent.EventType.Wheel.FORWARD|MCDEvent.EventType.Wheel.BACK|MCDEvent.EventType.Joystick.UP|MCDEvent.EventType.Joystick.DOWN|MCDEvent.EventType.Joystick.RIGHT|MCDEvent.EventType.Joystick.LEFT,this._handleMCDEvents.bind(this)),this.listItems=[];var titleClasses=["oc-textview-title"];attrs.title&&this.isShowTitle()&&titleClasses.push("has-text"),this.isShowTitle()&&(this.title=new TextView({classNames:titleClasses,model:{text:attrs.title||""}}))},getListItem:function(index){return this.listItems[index]},getSelectedListItem:function(){return this.getListItem(this.getCurrentIndex())},getCurrentIndex:function(){return this.get("selectedIndex")},getArrayList:function(){return this.model.get("arrayList")},addItems:function(items,silent){var i,arrayList=this.getArrayList();if(arrayList&&Array.isArray(items))for(i=0;i<items.length;i++)silent&&arrayList.silent(),arrayList.push(items[i]);return this},clear:function(){this.getArrayList()&&(this.set("selectedIndex",0),this.resetToInitialPosition(this.element,!0),this.getArrayList().clear())},addItemClickListener:function(listener){return this.itemClickListeners.push(listener),this},addItemLongClickListener:function(listener){return this.itemLongClickListeners.push(listener),this},addSelectedItemClickedListener:function(listener){return this.subscribe(ListView.Event.SELECTED_ITEM_CLICKED,listener)},removeSelectedItemClickedListener:function(listener){return this.unsubscribe(ListView.Event.SELECTED_ITEM_CLICKED,listener)},clearAllClickListeners:function(){this.itemClickListeners=[],this.itemLongClickListeners=[]},addItemChangedListener:function(listener){return this.subscribe(ListView.Event.CHANGED,listener)},removeItemChangedListener:function(listener){return this.unsubscribe(ListView.Event.CHANGED,listener)},addItemSelectedListener:function(listener){return this.subscribe(ListView.Event.SELECTED,listener)},removeItemSelectedListener:function(listener){return this.unsubscribe(ListView.Event.SELECTED,listener)},addPastLastListener:function(listener){return this.subscribe(ListView.Event.PASTLAST,listener)},removePastLastListener:function(listener){return this.unsubscribe(ListView.Event.PASTLAST,listener)},addBeforeFirstListener:function(listener){return this.subscribe(ListView.Event.BEFOREFIRST,listener)},removeBeforeFirstListener:function(listener){return this.unsubscribe(ListView.Event.BEFOREFIRST,listener)},addBeforeChangeListener:function(listener){return this.subscribe(ListView.Event.BEFORE_CHANGE,listener)},removeBeforeChangeListener:function(listener){return this.unsubscribe(ListView.Event.BEFORE_CHANGE,listener)},getInitialTranslateYOffset:function(){return 0},"Key Inherited Methods":undefined,isShowTitle:function(){return this.get("showTitle")},mixinMode:function(mode){this.mode&&this.mode.removeStyles.call(this),this.modeName=mode;switch(mode){case ListView.Mode.LIST:ListViewMixIn.mixin(this),this.mode=ListViewMixIn;break;case ListView.Mode.CENTERED_LIST:CenteredListViewMixIn.mixin(this),this.mode=CenteredListViewMixIn;break;case ListView.Mode.GRID:GridViewMixIn.mixin(this),this.mode=GridViewMixIn}},switchMode:function(mode){this.mixinMode(mode),this.mode.refresh.call(this)},getBottomFaderHeight:function(){return 0},_getControlDefaults:function($super){return ObjectUtils.merge($super(),{selectedIndex:0,visibleLength:5,visibleBuffer:3,showTitle:!0,listItemViewType:ListItemView,initialIndex:undefined,itemChanged:undefined,itemSelected:undefined,beforeChange:undefined,pastLast:undefined,beforeFirst:undefined,itemClick:undefined,itemLongClick:undefined,disabled:!1,childProps:undefined,parentBoundingClientRect:undefined,listItemTemplate:undefined})},_getModelDefaults:function(){return{arrayList:new ArrayList}},_generateElement:function(notDefault){return this._generateElementBase(notDefault)},_reuseElement:function(){return this._generateElement(!1)},render:function($super,parent){return this.parent=parent,this.isShowTitle()&&(this.title.render(parent),this.setTitle(this.title.model.get("text"))),this.element&&(this.element.addEventListener("blur",function(){this.mc.off(eventNames)}.bind(this),!1),this.element.addEventListener("focus",function(){this.mc&&this.mc.off(eventNames),this.mc=new Hammer(this.element,{}),this.mc.get("pan").set({direction:Hammer.DIRECTION_ALL}),this.mc.on(eventNames,this.onGestures.bind(this))}.bind(this),!1)),$super(parent)}.override(),onGestures:function(e){var SUPPORT_TOUCH="ontouchstart"in window,ul=this.getListElement(),tY=(ul.transformY?ul.transformY:this.getInitialTranslateYOffset())+e.deltaY,ulBounds=ul.getBoundingClientRect(),wrapperBounds=this.element.getBoundingClientRect();if(SUPPORT_TOUCH){if(e.pointerType=="touch")switch(e.type){case"pandown":case"panup":DOMHelper.transform(ul,"translateY("+tY+"px)",function(){var worth=Math.round(e.deltaY/this.liHeight);worth=-1*worth,this.nextIndex=this.get("selectedIndex")+worth}.bind(this),!0);break;case"panstart":break;case"panend":ul.transformY=tY,this.nextIndex>=this.getArrayList().length?this.nextIndex=this.getArrayList().length-1:this.nextIndex<0&&(this.nextIndex=0),this.set("selectedIndex",this.nextIndex);var parentTop=wrapperBounds.top,ulTop=ulBounds.top,diff=parentTop-ulTop;this.publish(ListView.Event.SCROLLED,this,-diff);if(tY>0)ul.transformY=0,DOMHelper.transform(ul,"translateY(0px)",function(){}.bind(this),!1);else{var ulBottom=ulBounds.bottom,wrapperBottom=wrapperBounds.bottom;if(ulBounds.height>wrapperBounds.height){if(ulBottom<wrapperBottom){diff=wrapperBottom-ulBottom;var tDiff=ul.transformY+diff;ul.transformY=tDiff,DOMHelper.transform(ul,"translateY("+tDiff+"px)",function(){}.bind(this),!1)}}else ul.transformY=0,DOMHelper.transform(ul,"translateY(0px)",function(){}.bind(this),!1)}break;case"swipe":Log.log("SWIPED")}}else Log.error("No TOUCH support?")},setItemsPerRow:function(count){this.itemsPerRow=count},setTitle:function(newTitle){this.isShowTitle()&&(this.title.model.get("text")!==newTitle&&this.title.model.set("text",newTitle),newTitle&&newTitle.trim().length?this.parent.classList.contains("has-text")||this.parent.classList.add("has-text"):this.parent.classList&&this.parent.classList.contains("has-text")&&this.parent.classList.remove("has-text"))},_generateElementBase:function(notDefault){var element=document.createElement("ul"),wrapper=document.createElement("div"),classes=this.get("classNames");for(var i=0,ii=classes.length;i<ii;i++)wrapper.classList.add(classes[i]);return this.get("noStyle")||(element.classList.add("oc-list-view"),wrapper.classList.add("oc-list-view-container"),notDefault||wrapper.classList.add("vertical")),wrapper.appendChild(element),wrapper},onPostRender:function(){this.onPostRenderBase()},onPostRenderBase:function(){var i=0,arrLen=this.getArrayList().length,ii=Math.min(arrLen,this.get("itemsPerPage"));this.set("selectedIndex",0),this.getArrayList().selectedIndex=0;if(arrLen>0){for(;i<ii;i++)this._push(i,!1,!0);ii<arrLen&&this._addListLoader(ii),typeof this.initialIndex!="undefined"?setTimeout(function(){this.set("selectedIndex",this.initialIndex),this.liHeight||(this.liHeight=this.getSelectedElement().getBoundingClientRect().height)}.bind(this),0):this._setSelectedElement(this.getSelectedElement()),setTimeout(function(){this.liHeight||(this.liHeight=this.getSelectedElement().getBoundingClientRect().height)}.bind(this),0),this.getArrayList().length&&this.getArrayList().length<=this.getListElement().childNodes.length&&(this.fullArrayList=!0)}else this._setEmptyUi();setupDownState(this.element),this._publishSelectedEvent()},_addBulkItems:function(start,end){var li,currentIndex=this.getArrayList(),fragment=document.createDocumentFragment();for(var i=start;i<end;i++)li=this._createListItemView(i),this.listItems[i]=li,li=li.render(this.getListElement()),i===currentIndex&&(li.element.classList.add("selected"),this.selectedElement=li.element),fragment.appendChild(li.element);return fragment},_setEmptyUi:function(){var ul=this.getListElement(),li=document.createElement("li");li.className="oc-listitemview list-empty",(new TextView({model:{text:"Nothing to display"}})).render(li),ul.appendChild(li),this.liHeight||(this.liHeight=li.getBoundingClientRect().height)},_removeEmptyUi:function(){var li=this.getListElement().querySelector(".list-empty");li&&li.parentNode.removeChild(li)},_addListLoader:function(index,parent){var ul=typeof parent=="undefined"?this.getListElement():parent,li=document.createElement("li");li.className="oc-listitemview list-load-more",li.setAttribute("data-adapter-index",index),(new TextView({model:{text:this.get("loadMoreText")||"&hellip;"}})).render(li),ul.appendChild(li),this.listItems[index]=li},_removeListLoader:function(){var ul=this.getListElement(),loader=ul.querySelector(".list-load-more"),index=Number(loader.getAttribute("data-adapter-index"));this.listItems[index]=null,loader&&loader.remove()},_createListItemView:function(dataindex){var node,ViewType=this.listItemViewType||this.get("listItemViewType"),listItemTemplate=this.get("listItemTemplate")||this.model.get("listItemTemplate"),model=this.getArrayList().getItem(dataindex),configs={model:model},childProps=this.get("childProps");return childProps&&(childProps instanceof Model&&(childProps=childProps.flatten()),configs=ObjectUtils.merge(childProps,configs)),listItemTemplate&&(configs.template=listItemTemplate),node=new ViewType(configs),node.model!==model&&this.getArrayList().silent().splice(dataindex,1,node.model.getAll()),node.set("index",dataindex),node.focusable=!1,node},_push:function(dataindex,infinite,silent){var li=this.listItems[dataindex],currentIndex=this.getCurrentIndex();return this._removeEmptyUi(),li||(li=this._createListItemView(dataindex),li instanceof DocumentFragment?this.listItems[dataindex]=li.firstChild:this.listItems[dataindex]=li),infinite&&li.element.classList.add("after-selected"),li=li.render(this.getListElement()),dataindex===currentIndex&&(li.element.classList.add("selected"),this.selectedElement=li.element,(typeof silent=="undefined"||silent===!1)&&this._publishSelectedEvent()),!this.liHeight&&li.element.getBoundingClientRect().height&&(this.liHeight=li.element.getBoundingClientRect().height),li.element},getLiHeight:function(){return this.liHeight},_pop:function(){var index,lastEl=this.getListElement().lastChild;return lastEl?(index=lastEl.getAttribute("data-adapter-index"),this.getCurrentIndex()===this.getArrayList().length&&this.set("selectedIndex",this.getCurrentIndex()-1)):Log.error("This is an empty list; nothing to pop"),this.listItems[index].remove()},_shift:function(removeItem){var firstChild=this.getListElement().firstChild,index=firstChild.getControl().get("index"),item=this.listItems[index];return item.remove(),removeItem&&(item=this.listItems.shift()),item},_unshift:function(dataindex,fromModel){var li=fromModel?this._createListItemView(dataindex):this.listItems[dataindex],selectedIndex=this.getCurrentIndex();return fromModel&&dataindex===0&&this.listItems.unshift(li),li||(li=this._createListItemView(dataindex),this.listItems[dataindex]=li),li=li.render(this.getListElement()),this.getListElement().hasChildNodes()?li=this.getListElement().insertBefore(li.element,this.getListElement().firstChild):li=this.getListElement().appendChild(li.element),dataindex===selectedIndex&&(fromModel&&this.set("selectedIndex",selectedIndex+1,!1),this.getSelectedElement().classList.add("selected"),this.listItems[selectedIndex].element.classList.remove("selected"),this._publishChangeEvent()),li},_splice:function($super,index,dataindex){var li=this.listItems[dataindex]||this._createListItemView(dataindex);return li=this.getListElement().insertBefore(li.element,this.getListElement().getChild(index)),li},getParentBoundingClientRect:function(){return this.get("parentBoundingClientRect")||this.element.getBoundingClientRect()},_onPropsChange:function(evt,type,prop,newValue,oldValue){if(type===Model.Event.TYPE.PROP)switch(prop){case"selectedIndex":this._onIndexChange(newValue,oldValue);break;case"disabled":newValue===!0?this.element.setAttribute("disabled",""):this.element.removeAttribute("disabled")}},onModelChange:function(evt,type,prop,newValue,oldValue){if(type===Model.Event.TYPE.PROP){var li,shouldPublish=!1,selectedIndex=this.getCurrentIndex(),arrayLen=this.getArrayList().length;switch(prop){case Model.Event.TYPE.MODIFY:var attrs=oldValue.getAll();for(var each in attrs)attrs.hasOwnProperty(each)&&this.getListItem(newValue).setAttribute(each,attrs[each]);break;case Model.Event.TYPE.PUSH:this._push(Math.max(arrayLen-1,0));break;case Model.Event.TYPE.POP:this._pop();break;case Model.Event.TYPE.SHIFT:this._shift(!0),this.getArrayList().length&&(reIndex(this.listItems,0),selectedIndex===0&&this._setSelectedElement(this.listItems[0].element));break;case Model.Event.TYPE.UNSHIFT:this._unshift(0,!0),reIndex(this.listItems,0);break;case Model.Event.TYPE.SPLICE:var newEndpoint,index=arguments[3],removed=arguments[4],added=arguments[5],newWritesLength=added-removed;index<0&&(index=this.getArrayList().length+index),newEndpoint=index+newWritesLength;if(removed){for(var i=index,ii=index+removed;i<ii;i++)li=this.listItems[i],li.parentNode.removeChild(li);this.listItems.splice(index,removed)}if(added)for(var j=Math.min(index,newEndpoint),jj=index+added;j<jj;j++)li=this._createListItemView(j),li.render(this.getListElement()),this.getListElement().insertBefore(li.element,this.getElementByMinIndex(j+1)),j<=this.listItems.length&&this.listItems.splice(j,0,li);reIndex(this.listItems,index),this.getCurrentIndex()!==0&&!this.getSelectedElement()&&this.set("selectedIndex",this.getArrayList().length-1,!0);break;case Model.Event.TYPE.CLEAR:this.set("selectedIndex",0,!0),this.getListElement().innerHTML="",this.listItems=[];break;case Model.Event.TYPE.CONCAT:var newindex=oldValue-1;this.getListElement().classList.add("no-animate"),window.requestAnimationFrame(function(){while(this.getListElement().childNodes.length<arrayLen)this._push(++newindex);window.requestAnimationFrame(function(){this.getListElement().classList.remove("no-animate")}.bind(this))}.bind(this));break;case Model.Event.TYPE.REPLACE:this.set("selectedIndex",0,!0),this.getListElement().innerHTML="",this.listItems=[],this.getListElement().classList.add("no-animate"),setupArrayList.call(this);for(var k=0,kk=newValue.length;k<kk;k++)this._push(k);this.getListElement().classList.remove("no-animate");break;case Model.Event.TYPE.SHUFFLE:this.set("selectedIndex",0,!0),newindex=-1,this.getListElement().innerHTML="",this.listItems=[];while(this.getListElement().childNodes.length<arrayLen)this._push(++newindex);this._setSelectedElement(this.getListElement().firstChild),reIndex(this.listItems,0),shouldPublish=!0;break;case"childArraySelectedIndex":if(newValue<0||newValue>=this.getArrayList().length){Log.warn("Attempt to set an index that is out of bounds of the ArrayList.");return}this.set("selectedIndex",newValue,!0)}window.requestAnimationFrame(function(){this.getSelectedElement()&&this._setSelectedElement(this.getSelectedElement()),shouldPublish&&(this._publishChangeEvent(),this._publishSelectedEvent()),this.getArrayList().length&&this.getArrayList().length==this.getListElement().childNodes.length&&(this.fullArrayList=!0)}.bind(this))}},loadNextPage:function(selectedElement,index,oldIndex,onTransitionComplete){this._setSelectedElement(selectedElement);var nextElement=selectedElement;if(nextElement&&nextElement.classList.contains("list-load-more")&&!nextElement.classList.contains("list-loading-more")){nextElement.classList.add("list-loading-more");var arrayList=this.getArrayList(),start=Number(nextElement.getAttribute("data-adapter-index")),end=Math.min(arrayList.length,start+this.get("itemsPerPage"));this.addOnIdleCallback(function(){var loader=this.getListElement().querySelector(".list-load-more");end<arrayList.length?(loader.setAttribute("data-adapter-index",end),loader.classList.remove("list-loading-more"),loader.classList.remove("selected"),this.listItems[end]=loader,this.getListElement().insertBefore(this._addBulkItems(start,end),loader)):this.getListElement().replaceChild(this._addBulkItems(start,end),loader),this._scrollParent(index,oldIndex,onTransitionComplete)}.bind(this))}},_select:function(index,oldIndex,noAnimate){var ul=this.getListElement(),selectedElement=this.getSelectedElement(),firstLoadedIndex=ul.firstChild?Number(ul.firstChild.getAttribute("data-adapter-index")):0,lastLoadedIndex=ul.querySelector("li:last-child")?Number(ul.querySelector("li:last-child").getAttribute("data-adapter-index")):0,loadMoreIndex=ul.querySelector("li.list-load-more")?Number(ul.querySelector("li.list-load-more").getAttribute("data-adapter-index")):-1;lastLoadedIndex===loadMoreIndex&&lastLoadedIndex--;var onTransitionComplete=function(){SFX.play("scroll"),this._publishSelectedEvent()}.bind(this);this._publishChangeEvent();if(index>=firstLoadedIndex&&index<=lastLoadedIndex)this._setSelectedElement(selectedElement),this._scrollParent(index,oldIndex,onTransitionComplete,noAnimate)||onTransitionComplete();else if(index===loadMoreIndex)this.get("fireToPaginate")?this._setSelectedElement(selectedElement):this.loadNextPage(selectedElement,index,oldIndex,onTransitionComplete);else{if(index<firstLoadedIndex)throw new Exception("selecting index lower than the loaded set is not yet supported",Exception.ErrorCode.UNIMPLEMENTED_METHOD);if(index>loadMoreIndex)throw new Exception("selecting index ("+index+") higher than the loaded set is not yet supported",Exception.ErrorCode.UNIMPLEMENTED_METHOD)}},_startAnimation:function(){this.__animatingRefCount++,this.__animating||(this.__animating=!0)},_endAnimation:function(){this.__animatingRefCount--;if(this.__animatingRefCount===0){this.__animating=!1;if(this._idleCallbacks.length){for(var i=0,j=this._idleCallbacks.length;i<j;i++)this._idleCallbacks[i]();this._idleCallbacks=[]}}},addOnIdleCallback:function(callback){this.__animating?this._idleCallbacks.push(callback):callback()},publishScrollEvent:function(diff){this.publish(ListView.Event.SCROLLED,this,-diff)},_scrollParent:function(index,oldIndex,onTransitionComplete,noAnimate){return this._scrollParentBase(index,oldIndex,onTransitionComplete,noAnimate)},_scrollParentBase:function(index,oldIndex,onTransitionComplete,noAnimate){var nextIndex=this.getCurrentIndex()+(index>oldIndex?1:-1);nextIndex==this.getArrayList().length?nextIndex=this.getCurrentIndex():nextIndex<0&&(nextIndex=this.getCurrentIndex());var element=this.getElementByIndex(nextIndex),scrolled=!1;if(element){var diff,parent=this.element,parentBounds=parent.getBoundingClientRect(),parentBottom=parentBounds.bottom,parentTop=parentBounds.top,elementBounds=element.getBoundingClientRect(),elementBottom=elementBounds.bottom,elementTop=elementBounds.top,ul=this.getListElement(),ulBounds=ul.getBoundingClientRect(),ulTop=ulBounds.top;elementBottom>parentBottom+this.getBottomFaderHeight()?(diff=elementBottom-parentBottom+this.getBottomFaderHeight(),diff+=parentTop-ulTop,scrolled=!0,this._startAnimation(),DOMHelper.transform(ul,"translateY(-"+diff+"px)",function(){typeof onTransitionComplete!="undefined"&&onTransitionComplete(),this._endAnimation()}.bind(this),noAnimate)):elementTop<parentTop&&(diff=parentTop-elementTop,diff=parentTop-ulTop-diff,this._startAnimation(),DOMHelper.transform(ul,"translateY(-"+diff+"px)",function(){typeof onTransitionComplete!="undefined"&&onTransitionComplete(),this._endAnimation()}.bind(this),noAnimate),scrolled=!0),diff!==undefined&&this.publishScrollEvent(-diff)}return scrolled},_isInViewPort:function(index){var selectedElement=this.getElementByIndex(index),selectedBounds=selectedElement&&selectedElement.getBoundingClientRect(),parentBounds=this.getParentBoundingClientRect();return selectedElement&&selectedBounds.top>=parentBounds.top&&selectedBounds.bottom<=parentBounds.bottom},_updateIndex:function(index){this.set("selectedIndex",index);for(var i=0,ii=this.itemClickListeners.length;i<ii;i++)this.itemClickListeners[i](this,this.getSelectedItem(),this.getElementByIndex(index))},_setSelectedElement:function(element){var oldSelected;element&&element.parentElement&&(oldSelected=element.parentElement.querySelector(".selected")),oldSelected&&oldSelected.classList.remove("selected"),element&&element.classList.add("selected")},_clickHandler:function(event){if(event&&event.sourceEvent&&event.sourceEvent.target){var index,item,isSelected,isFireEvent=event.eventType===MCDEvent.EventType.Joystick.FIRE,target=event.sourceEvent.target;while(target.parentElement!==this.getListElement()&&target!==this.getListElement())target=target.parentElement;if(target&&target.nodeName==="LI"&&target.hasAttribute("data-adapter-index")){index=parseInt(target.getAttribute("data-adapter-index"),10);if(this.getControlItem(index).get("disabled")||this.get("disabled"))return;isSelected=index===this.getCurrentIndex(),isSelected||(isFireEvent&&DOMHelper.addCompatSingleTransitionEndEventListener(target,function(){window.setTimeout(function(){this.publish(ListView.Event.SELECTED_ITEM_CLICKED,this,item,target)}.bind(this),125)}.bind(this),["-webkit-transform","-o-transform","transform"]),this.set("selectedIndex",index)),item=this.getSelectedItem();if(event.eventType===MCDEvent.EventType.Joystick.FIRE){for(var i=0,ii=this.itemClickListeners.length;i<ii;i++)this.itemClickListeners[i](this,item,target,isSelected);isSelected&&this.publish(ListView.Event.SELECTED_ITEM_CLICKED,this,item,target)}else{for(var j=0,jj=this.itemLongClickListeners.length;j<jj;j++)this.itemLongClickListeners[j](this,item,target,isSelected);isSelected&&this.publish(ListView.Event.SELECTED_ITEM_LONG_CLICKED,this,item,target,isSelected)}}}},_fire:function(e){var element=this.getSelectedElement();if(!element)return;if(!element.classList.contains("list-load-more")&&!element.classList.contains("list-empty")){var item=this.getSelectedItem();if(e.eventType===MCDEvent.EventType.Joystick.FIRE){for(var i=0,ii=this.itemClickListeners.length;i<ii;i++)this.itemClickListeners[i](this,item,element);this.publish(ListView.Event.SELECTED_ITEM_CLICKED,this,item,element)}else{for(var j=0,jj=this.itemLongClickListeners.length;j<jj;j++)this.itemLongClickListeners[j](this,item,element);this.publish(ListView.Event.SELECTED_ITEM_LONG_CLICKED,this,item,element)}}else if(element.classList.contains("list-load-more")){var onTransitionComplete=function(){SFX.play("scroll"),this._publishSelectedEvent()}.bind(this);this.loadNextPage(element,this.get("selectedIndex"),this.get("selectedIndex")-1,onTransitionComplete)}},getElementByMinIndex:function(index){for(var i=index,ii=index+this.listItems.length,item;i<ii;i++){item=this.getListElement().querySelector('li[data-adapter-index="'+i+'"]');if(item)return item}return undefined},getElementByIndex:function(index){return this.getListElement().querySelector('li[data-adapter-index="'+index+'"]')},getSelectedItem:function(){return this.getItemModel(this.getCurrentIndex())},getSelectedElement:function(){return this.getElementByIndex(this.getCurrentIndex())},getItemModel:function(index){return this.getArrayList()&&this.getArrayList().getItem(index)},getControlItem:function(index){return index instanceof Model&&(index=this.getArrayList().indexOf(index)),this.listItems[index]},getListElement:function(){return this.element.firstChild},setBaseListeners:function(listeners){typeof listeners.focusListener=="function"&&this.addFocusListener(listeners.focusListener),typeof listeners.blurListener=="function"&&this.addBlurListener(listeners.blurListener),typeof listeners.itemClickListener=="function"&&this.addItemClickListener(listeners.itemClickListener),typeof listeners.itemChangedListener=="function"&&this.addItemChangedListener(listeners.itemChangedListener),typeof listeners.itemSelectedListener=="function"&&this.addItemSelectedListener(listeners.itemSelectedListener),typeof listeners.focusable=="boolean"&&this.setFocusable(listeners.focusable),typeof listeners.selectedItemClickedListener=="function"&&this.addSelectedItemClickedListener(listeners.selectedItemClickedListener),typeof listeners.beforeChangeListener=="function"&&this.addBeforeChangeListener(listeners.beforeChangeListener)},_publishChangeEvent:function(){this.publish(ListView.Event.CHANGED,this,this.getSelectedItem())},_publishBeforeChangeEvent:function(){this.publish(ListView.Event.BEFORE_CHANGE,this,this.getSelectedItem())},_publishSelectedEvent:function(){this.publish(ListView.Event.SELECTED,this,this.getSelectedItem(),this.getSelectedElement())},_setMoreItemsClasses:function(){this._isInViewPort(this.getTopIndex())?this.element.classList.remove("more-above"):this.element.classList.add("more-above"),this._isInViewPort(this.getBottomIndex())?this.element.classList.remove("more-below"):this.element.classList.add("more-below")},getDefaultMode:function(){return ListView.Mode.LIST},reload:function(descending,listItems,selectedIndex){var listElement=this.getListElement(),indexToSelect=typeof selectedIndex!="undefined"?selectedIndex:0;listItems&&listItems.listItemViewType?this.listItemViewType=listItems.listItemViewType:this.listItemViewType=undefined,this.resetToInitialPosition(listElement,!0),typeof descending=="undefined"?(listItems&&listItems.mode?this.switchMode(listItems.mode):this.switchMode(this.getDefaultMode()),this._loadData.call(this,listItems,indexToSelect),this._select(indexToSelect,indexToSelect)):(this.animateToNewView(descending,listItems,indexToSelect),this.disabled=!1)},resetToInitialPosition:function(listElement,immediate){var translate,computedStyle=window.getComputedStyle(listElement),transformObject=computedStyle&&computedStyle.webkitTransform;transformObject||(transformObject=computedStyle.oTransform,transformObject==="none"&&(transformObject=null));var transformY=transformObject?(new CSSMatrix(transformObject)).m42:undefined;if(transformY&&transformY!==this.getInitialTranslateYOffset()){translate="translateY("+this.getInitialTranslateYOffset()+"px)";if(immediate!==undefined&&immediate===!0){listElement.classList.add("notransition"),DOMHelper.transform(listElement,translate);var offsetHeight=listElement.offsetHeight;listElement.classList.remove("notransition"),listElement.transformY=this.getInitialTranslateYOffset()}else this._startAnimation(),this.__ignoreKeys=!0,DOMHelper.addCompatSingleTransitionEndEventListener(this.getListElement(),function(){this.__ignoreKeys=!1,this._endAnimation()}.bind(this),["-webkit-transform","-o-transform","transform"]),DOMHelper.transform(listElement,translate),listElement.transformY=undefined}},_loadData:function(listItems,indexToSelect){listItems=listItems||[],this.getArrayList().clear(),listItems.length&&this.addItems(listItems,!0);var i=0,arrLen=this.getArrayList().length,ii=Math.min(arrLen,this.get("itemsPerPage"));if(arrLen>0){for(;i<ii;i++)this._push(i,!1,!0);ii<arrLen&&this._addListLoader(ii)}else this._setEmptyUi();var selectedItemModel=listItems[indexToSelect]||{};if(selectedItemModel.$disabled===!0){var foundNextItemToSelect=!1,nextIndex=indexToSelect;while(++nextIndex<listItems.length-1)if(listItems[nextIndex].$disabled===undefined||listItems[nextIndex].$disabled===!1){foundNextItemToSelect=!0;break}if(!foundNextItemToSelect){nextIndex=-1;while(++nextIndex<indexToSelect)if(listItems[nextIndex].$disabled===undefined||listItems[nextIndex].$disabled===!1){foundNextItemToSelect=!0;break}}foundNextItemToSelect?indexToSelect=nextIndex:Log.error("There's no item to select")}if(indexToSelect>0){var curr=this.get("selectedIndex");this.set("selectedIndex",indexToSelect,!0),this._select(indexToSelect,curr,!0)}},animateToNewView:function(descending,listItems,indexToSelect){var promise=new Promise;return this.mode.animateOut.call(this,descending,listItems,indexToSelect),!listItems||!listItems.mode?this.switchMode(this.getDefaultMode()):listItems.mode!=this.mode&&this.switchMode(listItems.mode),Promise.wrap(this.mode.animateIn.call(this,descending,listItems,indexToSelect)).done(function(){promise.resolve(),this.requestFocus()}.bind(this)),promise},_handleMCDEvents:function(e){return this.mode._handleMCDEvents.call(this,e)},_handleMCDEventsBase:function(e){if(!this.__ignoreKeys&&this.get("disabled")===!1){var mask=MCDEvent.EventType.Joystick.FIRE|MCDEvent.EventType.Joystick.FIRE_AND_HOLD,selectedIndex=this.getCurrentIndex(),arrayLen=this.getArrayList().length;if(this.disabled)return!1;if(e.eventType===MCDEvent.EventType.Wheel.FORWARD||e.eventType===MCDEvent.EventType.Joystick.DOWN){if(selectedIndex===-1&&e.isRepeat())return;selectedIndex+1<arrayLen?this.listItems[selectedIndex+1]&&(this._publishBeforeChangeEvent(),this.set("selectedIndex",++selectedIndex),e.stopPropagation()):this.publish(ListView.Event.PASTLAST,this,this.getSelectedItem()),e.preventDefault()}else if(e.eventType===MCDEvent.EventType.Wheel.BACK||e.eventType===MCDEvent.EventType.Joystick.UP){if(selectedIndex===arrayLen&&e.isRepeat())return;this._publishBeforeChangeEvent(),this.set("selectedIndex",--selectedIndex),e.preventDefault()}else e.eventType&mask&&!e.isRepeat()&&(e.sourceEvent&&(e.sourceEvent.type==="mousedown"||e.sourceEvent.type==="touchstart")&&e.sourceEvent.target&&e.sourceEvent.target.compareDocumentPosition(this.element)&this.element.DOCUMENT_POSITION_CONTAINS?this._clickHandler(e):e.sourceEvent instanceof MouseEvent?e.target.element!==this.element&&this._fire(e):this._fire(e),e.preventDefault())}},_onIndexChange:function(newValue,oldValue){var selectedElement=this.getElementByIndex(newValue),disabled=selectedElement?selectedElement.getAttribute("disabled"):null,enabled=disabled===null||disabled===!1;if(enabled){var arrayLen=this.getArrayList().length,visLen=this.get("visibleLength"),shouldContinue=!0;newValue===oldValue||newValue===0&&!oldValue?shouldContinue=!1:newValue<0?newValue===-2&&oldValue===-1?(this.set("selectedIndex",arrayLen-1,!0),newValue=arrayLen-1,oldValue=0):arrayLen>visLen?(this.set("selectedIndex",oldValue,!0),this.publish(ListView.Event.BEFOREFIRST,this,this.getSelectedItem()),shouldContinue=!1):(this.set("selectedIndex",oldValue,!0),this.publish(ListView.Event.BEFOREFIRST,this,this.getSelectedItem()),shouldContinue=!1):newValue>=arrayLen&&(newValue===arrayLen+1&&oldValue===arrayLen?(this.set("selectedIndex",0,!0),newValue=0,oldValue=arrayLen-1):arrayLen>visLen?(this.set("selectedIndex",oldValue,!0),this.publish(ListView.Event.PASTLAST,this,this.getSelectedItem()),shouldContinue=!1):(this.set("selectedIndex",oldValue,!0),this.publish(ListView.Event.PASTLAST,this,this.getSelectedItem()),shouldContinue=!1));if(shouldContinue){this._previousIndex=oldValue;var selectedIndex=this.get("selectedIndex");selectedIndex!==newValue?this.set("selectedIndex",newValue):this._select(newValue,oldValue)}}else{var forward=newValue>oldValue,nextIndex=forward?newValue+1:newValue-1;nextIndex>this.getArrayList().length-1&&(nextIndex=0),nextIndex<0&&(nextIndex=this.getArrayList().length-1),this._onIndexChange(nextIndex,oldValue)}}});ListView.Event={CHANGED:"/ui/control/listview/item/changed",PASTLAST:"/ui/control/listview/item/nextpast",BEFOREFIRST:"/ui/control/listview/item/beforefirst",SELECTED:"/ui/control/listview/item/selected",SELECTED_ITEM_CLICKED:"/ui/control/listview/item/selected/clicked",SELECTED_ITEM_LONG_CLICKED:"/ui/control/listview/item/selected/longclicked",BEFORE_CHANGE:"/ui/control/listview/item/beforechanged",SCROLLED:"/ui/control/listview/scrolled"},Object.freeze(ListView.Event),ListView.Mode={LIST:"list",CENTERED_LIST:"centered-list",GRID:"grid"},Object.freeze(ListView.Mode);var setupArrayList=function(){var arrayList=this.model.get("arrayList");if(arrayList instanceof ArrayList){var Instance=arrayList.itemModel||Model;for(var i=0,ii=arrayList.length,item;i<ii;i++)item=arrayList.getItem(i),item instanceof Instance||arrayList.silent().updateItem(i,new Instance(item))}else this.model.set("arrayList",new ArrayList(arrayList,{itemModel:Model,legacy:!0})),arrayList=this.getArrayList();arrayList.isSubscribed(Model.Event.EV_CHANGED,this.modelChangeMethod)||arrayList.subscribe(Model.Event.EV_CHANGED,this.modelChangeMethod)},reIndex=function(arrayList,fromIndex){var index=fromIndex||0;for(var i=index,ii=arrayList.length;i<ii;i++)arrayList[i]&&arrayList[i].set("index",i)},setupDownState=function(element){element.addEventListener("keydown",function(e){e.keyCode===13&&this.classList.add("oc-down-state")},!1),element.addEventListener("keyup",function(e){e.keyCode===13&&this.classList.remove("oc-down-state")},!1),element.addEventListener("mousedown",function(e){this.classList.add("oc-down-state")},!1),element.addEventListener("mouseup",function(e){this.classList.remove("oc-down-state")},!1),element.addEventListener("mouseout",function(e){this.classList.remove("oc-down-state")},!1)};return ListView});