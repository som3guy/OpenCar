define(["require","common/Config","common/Context","common/FocusController","common/ObjectUtils","common/PlatformConfig","common/StartingAppIds","common/lib/Router","common/lib/BrowserWindowRouterEventSource","common/lib/Promise","common/worker/PresentationPlatformWorkerConnection","common/worker/WorkerResponse","common/worker/WorkerEvent","common/platform/PlatformWorkerRequestCommand","common/platform/ActivationAPI","common/platform/RegistryAPI","common/platform/ProfileManagerAPI","common/platform/ThemeManagerAPI","common/platform/SettingsManagerAPI","common/platform/PlatformWorkerEventType","platform/presentation/PlatformViewport","platform/presentation/SystemDialogManager","platform/presentation/PlatformPresentationEventType","platform/presentation/PlatformFocusController","platform/presentation/ATMediaSupport","platform/presentation/animation/ApplicationAnimation","common/ObjectPool","common/platform/Profile","common/platform/Setting","common/lib/SFX"],function(require){"use strict";var Config=require("common/Config"),Context=require("common/Context"),FocusController=require("common/FocusController"),ObjectUtils=require("common/ObjectUtils"),PlatformConfig=require("common/PlatformConfig"),StartingAppIds=require("common/StartingAppIds"),Router=require("common/lib/Router"),BrowserWindowRouterEventSource=require("common/lib/BrowserWindowRouterEventSource"),Promise=require("common/lib/Promise"),PresentationPlatformWorkerConnection=require("common/worker/PresentationPlatformWorkerConnection"),WorkerResponse=require("common/worker/WorkerResponse"),WorkerEvent=require("common/worker/WorkerEvent"),PlatformWorkerRequestCommand=require("common/platform/PlatformWorkerRequestCommand"),ActivationAPI=require("common/platform/ActivationAPI"),RegistryAPI=require("common/platform/RegistryAPI"),ProfileManagerAPI=require("common/platform/ProfileManagerAPI"),ThemeManagerAPI=require("common/platform/ThemeManagerAPI"),SettingsManagerAPI=require("common/platform/SettingsManagerAPI"),PlatformWorkerEventType=require("common/platform/PlatformWorkerEventType"),PlatformViewport=require("platform/presentation/PlatformViewport"),SystemDialogManager=require("platform/presentation/SystemDialogManager"),PlatformPresentationEventType=require("platform/presentation/PlatformPresentationEventType"),PlatformFocusController=require("platform/presentation/PlatformFocusController"),ATMediaSupport=require("platform/presentation/ATMediaSupport"),ApplicationAnimation=require("platform/presentation/animation/ApplicationAnimation");require("common/ObjectPool"),require("common/platform/Profile"),require("common/platform/Setting"),require("common/lib/SFX");var context,router,connection,activationAPI,profileManagerAPI,settingsManagerAPI,themeManagerAPI,registryAPI,applicationDelegates={},cssIncludes=[],addCssIncludes=function(files){cssIncludes=cssIncludes.concat(files)},proceed=function(){activationAPI=new ActivationAPI,profileManagerAPI=new ProfileManagerAPI,settingsManagerAPI=new SettingsManagerAPI,themeManagerAPI=new ThemeManagerAPI,registryAPI=new RegistryAPI,themeManagerAPI.getGlobalCss().done(addCssIncludes).then(function(){return this._getThemeCssTask(addCssIncludes)}.bind(this)).then(function(){return themeManagerAPI.getThemeGuiCss().done(addCssIncludes)}).then(function(){return themeManagerAPI.getUserAgentCss().done(addCssIncludes)}).then(function(){return registryAPI.load()}).then(function(){return PlatformViewport.render(document.body,cssIncludes)}).done(function(){router.register("*",function(){document.getElementById("oc-apps-viewport").classList.add("spinner"),(new WorkerEvent({eventType:PlatformPresentationEventType.URL_HASH_CHANGE,data:document.location.hash})).send(connection)})}).error(function(){var i,ii;for(i=0,ii=arguments.length;i<ii;i++)Array.isArray(arguments[i])&&arguments[i].length>0&&Log.fatal("Error initializing platform: "+(arguments[i][0]&&arguments[i][0].message));PlatformViewport.showBootError("Sorry, the platform failed to launch."),connection.close()})},PlatformPresentationController={start:function(){router=new Router(new BrowserWindowRouterEventSource(window)),SystemDialogManager.setRouter(router),window.getFocusedItem=function(){return PlatformFocusController.getFocusedItem()},window.setFocusedItem=function(item){PlatformFocusController.setFocusedItem(item)},PlatformFocusController.subscribe(FocusController.Event.HOME_BUTTON_EVENT,this.onHomeButton),PlatformFocusController.subscribe(FocusController.Event.BACK_BUTTON_EVENT,this.onBackButton),PlatformFocusController.subscribe(FocusController.Event.NAV_BUTTON_EVENT,this.onNavButton),PlatformFocusController.subscribe(FocusController.Event.MEDIA_BUTTON_EVENT,this.onMediaButton),window.oc={states:{systemState:{}}},window.getSystemState=function(){return window.oc.states.systemState};var createConnection=function(){connection=this._connection,this._initConnection(connection),connection.start(),connection.ready().done(function(){context=new Context({connection:connection}),proceed.call(this)}.bind(this))};Config.mockSharedWorker?require(["common/worker/local/PresentationPlatformLocalConnection","common/worker/worker-utils"],function(LocalPresentationPlatformWorkerConnection){this._connection=new LocalPresentationPlatformWorkerConnection,createConnection.call(this)}.bind(this)):(this._connection=new PresentationPlatformWorkerConnection,createConnection.call(this))},_getThemeCssTask:function(addCssIncludes){return themeManagerAPI.getThemeCss().done(addCssIncludes)},onHomeButton:function(){document.location.hash="/app/"+StartingAppIds.homeScreenApplicationId+"/?reset=true&t="+Date.now()},onNavButton:function(){document.location.hash="/app/com.opencar.poi.dev.maps-example-with-plugins/?reset=true&t="+Date.now()},onMediaButton:function(){document.location.hash="/app/"+StartingAppIds.homeScreenApplicationId+"/category/media?reset=true&t="+Date.now()},onBackButton:function(){var hash=document.location.hash,menuAppId=StartingAppIds.backDestinationApplicationId;hash.indexOf("#/app/"+menuAppId)===0&&typeof applicationDelegates[menuAppId].getModuleView().viewCategories=="function"?(document.location.hash="/app/"+menuAppId,applicationDelegates[menuAppId].getModuleView().viewCategories()):document.location.hash="/app/"+menuAppId+"?appId="+hash.slice(6,Math.max(hash.indexOf("?"),hash.length))},_onAppActionAnnounce:function(id,name,cat){document.location.hash="/app/"+StartingAppIds.backDestinationApplicationId+"/?reset=true&appId="+id+"&categoryId="+cat+"&name="+name+"&t="+Date.now()},_initConnection:function(connection){var controller=this;PlatformConfig.useAudioTagMedia&&ATMediaSupport.setup(connection),connection.addRequestListener(PlatformWorkerRequestCommand.SET_URL_HASH,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS});request.params[0]?router.load(request.params[0]):response.setStatus(WorkerResponse.Status.ERROR),response.send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.SET_URL_SUBHASH,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS});request.params[0]?router.loadSubhash(request.params[0]):response.setStatus(WorkerResponse.Status.ERROR),response.send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.SETUP_APPLICATION_VIEW,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.ERROR}),initPromise=new Promise,config=request.getParams().shift(),error;config&&config.id?PlatformViewport.renderApplicationContainer(config.id,config.path).then(function(doc){doc.ready(function(){var delegate=doc.getModuleDelegate(config),error;applicationDelegates[config.id]?(error="Application "+config.id+" has an existing delegate.",Log.error(error),initPromise.reject(error)):(applicationDelegates[config.id]=delegate,delegate.getFocusController().subscribe(FocusController.Event.HOME_BUTTON_EVENT,controller.onHomeButton),delegate.getFocusController().subscribe(FocusController.Event.BACK_BUTTON_EVENT,controller.onBackButton),delegate.getFocusController().subscribe(FocusController.Event.NAV_BUTTON_EVENT,controller.onNavButton),delegate.getFocusController().subscribe(FocusController.Event.MEDIA_BUTTON_EVENT,controller.onMediaButton),PlatformFocusController.addAppFocusController(config.id,delegate.getFocusController()),initPromise.resolve())})}):(error="Cannot setup view, no application id.",Log.error(error),initPromise.reject(error)),initPromise.done(function(){response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)}).error(function(){response.send(connection)})}),connection.addRequestListener(PlatformWorkerRequestCommand.LOAD_APP_DEPENDENCIES,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.ERROR}),id=request.getParams().shift();id?applicationDelegates[id]?Promise.when(applicationDelegates[id].loadControllerDependencies(connection.worker),applicationDelegates[id].loadViewDependencies()).then(function(){response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)},function(){response.send(connection)}):response.setData("Cannot load application dependencies, no delegate for "+id).send(connection):response.send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.DESTROY_APPLICATION,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS}),id=request.getParams().shift();Log.debug("DESTROY_APPLICATION",id),PlatformViewport.removeApplicationContainer(id),PlatformFocusController.removeAppFocusController(id),delete applicationDelegates[id],response.send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.ANIMATE_IN_APPLICATION,function(request){PlatformViewport.hideSplash();var response=new WorkerResponse({request:request,status:WorkerResponse.Status.ERROR}),config=request.getParams().shift();return Promise.when(registryAPI.getModuleData(config.inApp.id),(new ApplicationAnimation(config.inApp.id,config.outApp&&config.outApp.id)).animate()).then(function(moduleDataArgs,appAnimationArgs){var moduleData=moduleDataArgs[0],id=moduleData._config.id,icon=moduleData._config.icon,title=moduleData._config.name;id===StartingAppIds.firstStartAppId&&(title="Home",icon=""),PlatformViewport.showOpenBarHomeButton(),PlatformViewport.setWindowTitle(id),PlatformViewport.setOpenBarTitleIcon(icon),PlatformViewport.setOpenBarTitle(title),activationAPI.reportApplicationTitle(title||""),response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)})}),connection.addRequestListener(PlatformWorkerRequestCommand.HIDE_LOADING_SPLASH,function(request){document.getElementById("oc-apps-viewport").classList.remove("spinner");var response=new WorkerResponse({request:request,status:WorkerResponse.Status.ERROR}),id=request.getParams()[0],background=request.getParams()[1],applicationContainer=PlatformViewport.getApplicationContainer(id),containerElement;applicationContainer?(containerElement=applicationContainer.getElement(),containerElement.querySelector("iframe").style.visibility="visible",applicationContainer.hideSplash().done(function(){background?(containerElement.classList.add("app-out"),containerElement.style.left="-100%",containerElement.style.opacity="0",response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)):response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)})):response.setData("No application container for "+id)}),connection.addRequestListener(PlatformWorkerRequestCommand.SHOW_LOADING,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.ERROR}),id=request.getParams()[0],applicationContainer=PlatformViewport.getApplicationContainer(id);applicationContainer?applicationContainer.showSplash("overlay",request.getParams()).done(function(){response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)}).error(function(){response.setData("No application container for "+id).send(connection)}):response.setData("No application container for "+id)}),connection.addRequestListener(PlatformWorkerRequestCommand.HIDE_LOADING,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.ERROR}),id=request.getParams()[0],applicationContainer=PlatformViewport.getApplicationContainer(id);applicationContainer?(applicationContainer.hideSplash("overlay"),response.setStatus(WorkerResponse.Status.SUCCESS).send(connection)):response.setData("No application container for "+id)}),connection.addRequestListener(PlatformWorkerRequestCommand.SHOW_LOAD_ERROR,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS});PlatformViewport.getApplicationContainer(request.getParams().shift()).showLoadError().done(function(){response.send(connection)})}),connection.addRequestListener(PlatformWorkerRequestCommand.DISPLAY_SYSTEM_DIALOG,function(request){var response=new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS});PlatformViewport.displaySystemDialog.apply(PlatformViewport,request.getParams()).done(function(){response.send(connection)})}),connection.addEventListener(PlatformPresentationEventType.MODULE_INSTALL_ACTION,function(event){var action=event.data.action,name=event.data.name,id=event.data.moduleId,cat=event.data.categoryId,success;action==="install"?(success=!!name&&!!name.length,success?Log.log("Module "+id+" has been installed ("+name+", "+cat+")"):Log.warn("Module "+id+" was announced as installed, but does not appear to be available")):action==="remove"&&(success=!name&&!cat,success?Log.log("Module "+id+" has been removed"):Log.warn("Module "+id+" was announced as removed, but continues to appear in registry")),controller._onAppActionAnnounce(id,name,cat)}),connection.addEventListener(PlatformPresentationEventType.THEME_CHANGED,function(event){PlatformViewport.changeTheme(event.data.themeName)}),connection.addEventListener(PlatformPresentationEventType.ACTIVE_PROFILE_CHANGED,function(event){PlatformViewport.changeProfile(event.data.profileId)}),connection.addEventListener(PlatformWorkerEventType.NOW_PLAYING_CHANGED,function(event){PlatformViewport.setNowPlayingInfo(event.data)}),connection.addRequestListener(PlatformWorkerRequestCommand.DISPLAY_STICKY_TOAST,function(request){var resp=new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS});PlatformViewport.setStickyInfo(request.data).always(function(uid){resp.setData(uid).send(connection)})}),connection.addRequestListener(PlatformWorkerRequestCommand.KILL_STICKY_TOAST,function(request){(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection),PlatformViewport.killStickyInfo(request.data.id)}),connection.addRequestListener(PlatformWorkerRequestCommand.DISPLAY_TOAST,function(request){(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection),PlatformViewport.toast(request.data)}),connection.addRequestListener(PlatformWorkerRequestCommand.CHANGE_OPENBAR_TITLE,function(request){(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection);var title=request.data.title,icon=request.data.icon,showHome=request.data.showHome;activationAPI.reportApplicationTitle(title||""),title?(PlatformViewport.setOpenBarTitle(title),icon?PlatformViewport.setOpenBarTitleIcon(icon):PlatformViewport.setOpenBarTitleIcon("")):(PlatformViewport.setOpenBarTitle(""),PlatformViewport.setOpenBarTitleIcon("")),showHome?PlatformViewport.showOpenBarHomeButton():(PlatformViewport.setOpenBarTitleIcon(""),PlatformViewport.hideOpenBarHomeButton())}),connection.addRequestListener(PlatformWorkerRequestCommand.SET_OPENBAR_STATE,function(request){(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection);var state=request.data.state;state&&PlatformViewport.setOpenBarState(state)}),connection.addRequestListener(PlatformWorkerRequestCommand.DISPLAY_SYSTEM_ALERT_INDICATOR,function(request){(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection),PlatformViewport.displaySystemAlertIcon()}),connection.addRequestListener(PlatformWorkerRequestCommand.HIDE_SYSTEM_ALERT_INDICATOR,function(request){(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection),PlatformViewport.hideSystemAlertIcon()}),connection.addRequestListener(PlatformWorkerRequestCommand.CHANGE_SYSTEM_STATE,function(request){window.oc.states.systemState=request.params[0],ObjectUtils.secure(window.oc.states.systemState),window.oc.states.systemState.isParked?PlatformViewport.displaySystemDialog():PlatformViewport.hideSystemDialog(),(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.LOCAL_STORAGE_SET,function(request){var k=request.params[0],v=request.params[1];window.localStorage.setItem(k,v),(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.LOCAL_STORAGE_GET,function(request){var k=request.params[0],v=window.localStorage.getItem(k);(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).setData(v).send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.LOCAL_STORAGE_REMOVE,function(request){var k=request.params[0];window.localStorage.removeItem(k),(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection)}),connection.addRequestListener(PlatformWorkerRequestCommand.LOCAL_STORAGE_CLEAR,function(request){window.localStorage.clear(),(new WorkerResponse({request:request,status:WorkerResponse.Status.SUCCESS})).send(connection)})}};return PlatformPresentationController});