define(["require","common/Class","common/FocusTarget","common/KeyboardMCDEventSource","common/FocusChangeEvent","common/MCDEvent","common/Config","common/PlatformConfig","common/PubSub","common/lib/SFX"],function(require){"use strict";var Class=require("common/Class"),FocusTarget=require("common/FocusTarget"),KeyboardMCDEventSource=require("common/KeyboardMCDEventSource"),FocusChangeEvent=require("common/FocusChangeEvent"),MCDEvent=require("common/MCDEvent"),Config=require("common/Config"),PlatformConfig=require("common/PlatformConfig"),PubSub=require("common/PubSub"),SFX=require("common/lib/SFX"),FocusAxisMap,FocusHistoryItem,FocusMap,passesFocusConstraintTest,createSortFunction,getHypotenuse,getDistanceBetweenPoints,getIntersection,getShortestDistance,isInLimit,SortedCoordCollection;passesFocusConstraintTest=function(focusedItem,item){var constraint=focusedItem.getFocusController().focusMap.currentFocusConstraint||this.currentFocusConstraint;return!constraint||constraint(item)},createSortFunction=function(axis,direction){return function(a,b){var aInt,bInt,aDist=getShortestDistance(axis,direction,window.getFocusedItem(),a),bDist=getShortestDistance(axis,direction,window.getFocusedItem(),b);if(aDist===bDist){aInt=getIntersection(axis,a,window.getFocusedItem()),bInt=getIntersection(axis,b,window.getFocusedItem());if(typeof aInt!="undefined"&&typeof bInt!="undefined")return bInt-aInt}return aDist-bDist}.bind(this)},getShortestDistance=function(axis,direction,a,b){var aPoint={x:undefined,y:undefined},bPoint={x:undefined,y:undefined};return a=a.getFocusRectangle(),b=b.getFocusRectangle(),axis===FocusAxisMap.Axis.Y?(direction>0?(aPoint.y=a.bottom,bPoint.y=b.top>aPoint.y?b.top:aPoint.y):(aPoint.y=a.top,bPoint.y=b.bottom<aPoint.y?b.bottom:aPoint.y),b.left>a.right?(aPoint.x=a.right,bPoint.x=b.left):b.right<a.left?(aPoint.x=a.left,bPoint.x=b.right):aPoint.x=bPoint.x=b.left<a.left?a.left:b.left):(direction>0?(aPoint.x=a.right,bPoint.x=b.left>aPoint.x?b.left:aPoint.x):(aPoint.x=a.left,bPoint.x=b.right<aPoint.x?b.right:aPoint.x),b.bottom<a.top?(aPoint.y=a.top,bPoint.y=b.bottom):b.top>a.bottom?(aPoint.y=a.bottom,bPoint.y=b.top):aPoint.y=bPoint.y=b.top<a.top?a.top:b.top),getDistanceBetweenPoints(aPoint,bPoint)},getIntersection=function(axis,a,b){var inter,prop1=axis===FocusAxisMap.Axis.X?"top":"left",prop2=axis===FocusAxisMap.Axis.X?"bottom":"right",dim=axis===FocusAxisMap.Axis.X?"height":"width";return a=a.getFocusRectangle(),b=b.getFocusRectangle(),a[prop1]>=b[prop1]?inter=Math.min(b[prop2],a[prop1]+a[dim])-a[prop1]:a[prop2]>=b[prop1]&&(inter=a[prop2]-b[prop1]),inter},isInLimit=function(limit,item){var dimensions=item.getFocusRectangle();return typeof limit.top!="undefined"&&limit.bottom&&(dimensions.top>=limit.top&&dimensions.top<=limit.bottom||dimensions.bottom<limit.bottom&&dimensions.bottom>=limit.top||dimensions.top<=limit.top&&dimensions.bottom>=limit.bottom)||typeof limit.left!="undefined"&&limit.right&&(dimensions.left>=limit.left&&dimensions.left<limit.right||dimensions.right<=limit.right&&dimensions.right>limit.left||dimensions.left<=limit.left&&dimensions.right>=limit.right)},getHypotenuse=function(a,b){return Math.sqrt(Math.pow(a,2)+Math.pow(b,2))},getDistanceBetweenPoints=function(a,b){return getHypotenuse(Math.abs(b.y-a.y),Math.abs(b.x-a.x))},SortedCoordCollection=function(){this.values=[]},SortedCoordCollection.prototype={add:function(value){var i;if(this.values.indexOf(value)===-1){i=this.values.length-1;while(i>=0&&value<this.values[i])i--;i===-1?this.values.unshift(value):i<this.values.length?this.values.splice(++i,0,value):this.values.push(value)}},remove:function(value){var i=this.values.indexOf(value);i!==-1&&this.values.splice(i,1)},getLength:function(){return this.values.length},getValue:function(index){return index>=0&&index<this.values.length?this.values[index]:undefined},getIndexOfValue:function(value){return this.values.indexOf(value)},getFirstValue:function(){return this.values.length>0?this.values[0]:undefined},getLastValue:function(){return this.values.length>0?this.values[this.values.length-1]:undefined},getNextValue:function(value,n){var i=this.getIndexOfValue(value);if(i>-1)i+=n;else if(n>0){for(var j=0,jj=this.values.length;j<jj;j++)if(this.values[j]>value){i=j;break}}else if(n<0)for(var k=this.values.length-1;k>=0;k--)if(this.values[k]<value){i=k;break}return i>=0&&i<this.values.length?this.values[i]:undefined},isFocusableContainer:function(){return this.isFocusable()&&this.hasChildren()}},FocusAxisMap=Class.create({initialize:function(axis){this.axis=axis,this.items={},this.coords=new SortedCoordCollection},addItem:function(item){var coord=item.getFocusRectangle()[this.axis===FocusAxisMap.Axis.Y?"top":"left"];this.items[coord]||(this.items[coord]=[]),this.items[coord].push(item),this.coords.add(coord)},refreshItem:function(item){var coord,newCoord=item.getFocusRectangle()[this.axis===FocusAxisMap.Axis.Y?"top":"left"],oldCoord,index,isChanged=!1;for(coord in this.items)if(this.items.hasOwnProperty(coord)&&(index=this.items[coord].indexOf(item))!==-1){oldCoord=parseFloat(coord);break}return index>=0&&oldCoord!==newCoord&&typeof oldCoord!="undefined"&&(this.items[oldCoord].splice(index,1),this.items[oldCoord].length===0&&(delete this.items[oldCoord],this.coords.remove(oldCoord)),this.coords.add(newCoord),this.items[newCoord]||(this.items[newCoord]=[]),this.items[newCoord].push(item),isChanged=!0),isChanged},removeItem:function(item){var i,coord=item.getFocusRectangle()[this.axis===FocusAxisMap.Axis.Y?"top":"left"];this.items[coord]&&(i=this.items[coord].indexOf(item),i>=0&&(this.items[coord].splice(i,1),this.items[coord].length===0&&(delete this.items[coord],this.coords.remove(coord))))},findEligibleItems:function(startCoord,mod,limit){var j,coord,item,eligibleItems=[],coordIndex=this.coords.getIndexOfValue(startCoord);if(coordIndex>=0&&coordIndex<this.coords.getLength())do{j=0,coord=this.coords.getValue(coordIndex);do{item=this.items[coord][j];if(item&&item.isFocusable())typeof limit=="function"?limit(item)&&eligibleItems.push(item):eligibleItems.push(item);else if(item&&item.isTargetable()&&item.children.length)for(var i=0,ii=item.children.length,child;i<ii;i++)child=item.children[i],child&&child.isFocusable()&&(typeof limit=="function"?limit(child)&&eligibleItems.push(child):eligibleItems.push(child))}while(++j<this.items[coord].length);coordIndex+=mod}while(coordIndex<this.coords.getLength()&&coordIndex>=0);return eligibleItems},getNextFocusableItem:function(startCoord,mod,limit,sortFunction){var eligibleItems;return eligibleItems=this.findEligibleItems(startCoord,mod,limit),eligibleItems.length>0&&typeof sortFunction=="function"&&eligibleItems.sort(function(a,b){return sortFunction(a,b)}.bind(this)),eligibleItems[0]||undefined},getFirstFocusableItem:function(){return this.getNextFocusableItem(this.getFirstCoord(),1,!1,function(a,b){var aRect=a.getFocusRectangle(),bRect=b.getFocusRectangle(),aDist=getDistanceBetweenPoints({x:0,y:0},{x:aRect.left,y:aRect.top}),bDist=getDistanceBetweenPoints({x:0,y:0},{x:bRect.left,y:bRect.top});return aDist-bDist})},getNextCoord:function(coord,mod){return this.coords.getNextValue(coord,mod)},getFirstCoord:function(){return this.coords.getFirstValue()},getLastCoord:function(){return this.coords.getLastValue()}}),FocusAxisMap.Axis={Y:"y",X:"x"},Object.freeze(FocusAxisMap.Axis),FocusHistoryItem=Class.create({initialize:function(prevTarget,direction){this.prevTarget=prevTarget,this.direction=direction}}),FocusMap=Class.create({initialize:function(focusTarget){this.items=[],this.xMap=new FocusAxisMap(FocusAxisMap.Axis.X),this.yMap=new FocusAxisMap(FocusAxisMap.Axis.Y),this.history=[],this.lastWheelRight=0,this.lastWheelLeft=0,this.canRefresh=!0},addItem:function(item){return item&&item.isFocusTarget&&!this.hasItem(item)&&(this.xMap.addItem(item),this.yMap.addItem(item),this.items.push(item),Config.enableFocusableIndicator&&item.getFocusElement()&&(item.isFocusable()?item.getFocusElement().setAttribute("data-focusable",1):item.getFocusElement().removeAttribute("data-focusable")),this.clearHistory()),this},hasItem:function(item){return this.items.indexOf(item)>=0},hasItems:function(){return this.items.length>0},removeItem:function(item){return this.hasItem(item)&&(this.xMap.removeItem(item),this.yMap.removeItem(item),this.items.splice(this.items.indexOf(item),1),this.clearHistory()),this},refresh:function(){if(this.canRefresh){var i,orphans=FocusTarget.orphanedFocusTargets.slice();for(i=0;i<orphans.length;i++)orphans[i].findParentFocusTarget()&&FocusTarget.orphanedFocusTargets.splice(FocusTarget.orphanedFocusTargets.indexOf(orphans[i]),1);for(i=0;i<this.items.length;i++)Config.enableFocusableIndicator&&this.items[i].getFocusElement()&&(this.items[i].isFocusable()?this.items[i].getFocusElement().setAttribute("data-focusable",1):this.items[i].getFocusElement().removeAttribute("data-focusable")),(this.xMap.refreshItem(this.items[i])||this.yMap.refreshItem(this.items[i]))&&this.items[i].isFocusable()&&this.clearHistory()}return this},focusFirstChild:function(parent){this.refresh();var rect=parent.getFocusRectangle(),target,xTarget,yTarget,yRect,xRect,yDist,xDist;return xTarget=this.xMap.getNextFocusableItem(this.xMap.getFirstCoord(),1,function(item){return parent.hasChild(item)},function(a,b){var aRect=a.getFocusRectangle(),bRect=b.getFocusRectangle(),aDist=getDistanceBetweenPoints({x:rect.left,y:rect.top},{x:aRect.left,y:aRect.top}),bDist=getDistanceBetweenPoints({x:rect.left,y:rect.top},{x:bRect.left,y:bRect.top});return aDist-bDist}.bind(this)),yTarget=this.yMap.getNextFocusableItem(this.yMap.getFirstCoord(),1,function(item){return parent.hasChild(item)}.bind(this),function(a,b){var aRect=a.getFocusRectangle(),bRect=b.getFocusRectangle(),aDist=getDistanceBetweenPoints({x:rect.left,y:rect.top},{x:aRect.left,y:aRect.top}),bDist=getDistanceBetweenPoints({x:rect.left,y:rect.top},{x:bRect.left,y:bRect.top});return aDist-bDist}.bind(this)),!yTarget&&xTarget?target=xTarget:yTarget&&!xTarget?target=yTarget:xTarget&&yTarget&&(yTarget===xTarget?target=yTarget:(yRect=yTarget.getFocusRectangle(),xRect=xTarget.getFocusRectangle(),yDist=getDistanceBetweenPoints({x:rect.left,y:rect.top},{x:yRect.left,y:yRect.top}),xDist=getDistanceBetweenPoints({x:rect.left,y:rect.top},{x:xRect.left,y:xRect.top}),yDist<xDist?target=yTarget:target=xTarget)),this.setFocus(target)},transferFocus:function(event,saveHistory){var focusedItemRect;this.refresh();if(this.hasItems()){focusedItemRect=window.getFocusedItem()?window.getFocusedItem().getFocusRectangle():undefined;switch(event.eventType){case MCDEvent.EventType.Joystick.RIGHT:return this.onStickRight(event,focusedItemRect,saveHistory);case MCDEvent.EventType.Joystick.DOWN:return this.onStickDown(event,focusedItemRect,saveHistory);case MCDEvent.EventType.Joystick.UP:return this.onStickUp(event,focusedItemRect,saveHistory);case MCDEvent.EventType.Joystick.LEFT:return this.onStickLeft(event,focusedItemRect,saveHistory)}}},onStickRight:function(event,focusedItemRect,saveHistory){var target,itemProxy,_this=this,focusedItem=window.getFocusedItem(),isFocused=!1,originPoint=focusedItemRect&&focusedItemRect.left,sortFunction=createSortFunction.call(this,FocusAxisMap.Axis.X,1),limitingFunc=function(item){return passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({top:focusedItemRect.top,bottom:focusedItemRect.bottom},item)&&(focusedItemRect?item.getFocusRectangle().left>=focusedItemRect.left:!0)};if(!focusedItemRect)isFocused=this.setFocus(this.getFirstFocusableItem(),event,saveHistory);else{isFocused=this.setFocusToPreviousItemInHistory(MCDEvent.EventType.Joystick.LEFT);if(!isFocused){itemProxy=focusedItem;while(!target&&itemProxy.hasParentFocusTarget())focusedItemRect=itemProxy.getFocusRectangle(),itemProxy=itemProxy.getParentFocusTarget(),target=this.xMap.getNextFocusableItem(this.xMap.getNextCoord(originPoint,1),1,limitingFunc,sortFunction);target||(target=this.xMap.getNextFocusableItem(this.xMap.getNextCoord(originPoint,1),1,function(item){return passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({top:0,bottom:document.height},item)},sortFunction)),isFocused=this.setFocus(target,event,saveHistory)}}return isFocused},onStickDown:function(event,focusedItemRect,saveHistory){var target,itemProxy,_this=this,focusedItem=window.getFocusedItem(),isFocused=!1,originPoint=focusedItemRect&&focusedItemRect.top,sortFunction=createSortFunction.call(this,FocusAxisMap.Axis.Y,1),limitingFunc=function(item){return passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({left:focusedItemRect.left,right:focusedItemRect.right},item)&&item.getFocusRectangle().left<window.getOffsetFromParent().left+PlatformConfig.screenWidth&&item.getFocusRectangle().right>0&&(focusedItemRect?item.getFocusRectangle().top>=focusedItemRect.top:!0)};if(!focusedItemRect)isFocused=this.setFocus(this.getFirstFocusableItem(),event,saveHistory);else{focusedItem.getFocusController()!==this.items[0].getFocusController()&&(originPoint-=1),isFocused=this.setFocusToPreviousItemInHistory(MCDEvent.EventType.Joystick.UP);if(!isFocused){itemProxy=focusedItem;while(!target&&itemProxy.hasParentFocusTarget())focusedItemRect=itemProxy.getFocusRectangle(),itemProxy=itemProxy.getParentFocusTarget(),target=this.yMap.getNextFocusableItem(this.yMap.getNextCoord(originPoint,1),1,limitingFunc,sortFunction);target||(target=this.yMap.getNextFocusableItem(this.yMap.getNextCoord(originPoint,1),1,function(item){return passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({left:0,right:PlatformConfig.screenWidth},item)},sortFunction)),isFocused=this.setFocus(target,event,saveHistory)}}return isFocused},onStickUp:function(event,focusedItemRect,saveHistory){var target,itemProxy,_this=this,focusedItem=window.getFocusedItem(),isFocused=!1,originPoint=focusedItemRect&&focusedItemRect.top,sortFunction=createSortFunction.call(_this,FocusAxisMap.Axis.Y,-1),limitingFunc=function(item){return item!==focusedItem&&passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({left:focusedItemRect.left,right:focusedItemRect.right},item)&&item.getFocusRectangle().left<window.getOffsetFromParent().left+PlatformConfig.screenWidth&&item.getFocusRectangle().right>0&&(focusedItemRect?item.getFocusRectangle().top<=focusedItemRect.top:!0)};if(focusedItemRect){focusedItem.getFocusController()!==this.items[0].getFocusController()&&(originPoint+=1),isFocused=this.setFocusToPreviousItemInHistory(MCDEvent.EventType.Joystick.DOWN);if(!isFocused){itemProxy=focusedItem;while(!target&&itemProxy.hasParentFocusTarget())focusedItemRect=itemProxy.getFocusRectangle(),itemProxy=itemProxy.getParentFocusTarget(),target=this.yMap.getNextFocusableItem(this.yMap.getNextCoord(originPoint,-1),-1,limitingFunc,sortFunction);target||(target=this.yMap.getNextFocusableItem(this.yMap.getNextCoord(originPoint,-1),-1,function(item){return item!==focusedItem&&passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({left:0,right:PlatformConfig.screenWidth},item)},sortFunction)),isFocused=this.setFocus(target,event,saveHistory)}}return isFocused},onStickLeft:function(event,focusedItemRect,saveHistory){var target,itemProxy,_this=this,focusedItem=window.getFocusedItem(),isFocused=!1,originPoint=focusedItemRect&&focusedItemRect.left,sortFunction=createSortFunction.call(this,FocusAxisMap.Axis.X,-1),limitingFunc=function(item){return item!==focusedItem&&passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({top:focusedItemRect.top,bottom:focusedItemRect.bottom},item)&&(focusedItemRect?item.getFocusRectangle().left<=focusedItemRect.left:!0)};if(focusedItemRect){isFocused=this.setFocusToPreviousItemInHistory(MCDEvent.EventType.Joystick.RIGHT);if(!isFocused){itemProxy=focusedItem;while(!target&&itemProxy.hasParentFocusTarget())focusedItemRect=itemProxy.getFocusRectangle(),itemProxy=itemProxy.getParentFocusTarget(),target=this.xMap.getNextFocusableItem(this.xMap.getNextCoord(originPoint,-1),-1,limitingFunc,sortFunction);target||(target=this.xMap.getNextFocusableItem(this.xMap.getNextCoord(originPoint,-1),-1,function(item){return item!==focusedItem&&passesFocusConstraintTest.call(_this,focusedItem,item)&&isInLimit({top:0,bottom:document.height},item)},sortFunction)),isFocused=this.setFocus(target,event,saveHistory)}}return isFocused},getFirstFocusableItem:function(){var firstX=this.xMap.getFirstFocusableItem(),firstY=this.yMap.getFirstFocusableItem(),item;if(firstX&&firstY)if(firstX===firstY)item=firstX;else{var xRect=firstX.getFocusRectangle(),yRect=firstY.getFocusRectangle(),distX=getDistanceBetweenPoints({x:0,y:0},{x:xRect.left,y:xRect.top}),distY=getDistanceBetweenPoints({x:0,y:0},{x:yRect.left,y:yRect.top});distX<=distY?item=firstX:item=firstY}else item=firstX||firstY;return item},handleMCDEvent:function(event,saveHistory){var focused;return!event.isDefaultPrevented()&&event.isJoystickEvent()&&event.eventType^MCDEvent.EventType.Joystick.FIRE&&(focused=this.transferFocus(event,saveHistory),focused&&(SFX.play("dpad_move"),event.preventDefault())),focused},clearHistory:function(){return this.history=[],this},setFocusToPreviousItemInHistory:function(direction){var isFocused,lastItem;if(this.history.length>0&&(lastItem=this.history[this.history.length-1]).direction===direction)return isFocused=this.setFocus(lastItem.prevTarget,undefined,!1),isFocused&&this.history.pop(),isFocused},setFocus:function(item,event,saveHistory){var focusedItem=window.getFocusedItem(),isFocused=!1,focusEvent;return saveHistory=typeof saveHistory!="undefined"?saveHistory:!0,this.refresh(),item&&item!==focusedItem&&item.isFocusable()&&(saveHistory&&focusedItem&&focusedItem.getFocusController()===item.getFocusController()&&(event?this.history.push(new FocusHistoryItem(focusedItem,event.eventType)):this.clearHistory()),focusEvent=new FocusChangeEvent(item,focusedItem),item.hasConstraintParent()?this.currentFocusConstraint=function(target){return target.getConstraintParent()===item.getConstraintParent()||!item.getFocusController().isPlatformFocusController&&target.getFocusController().isPlatformFocusController}:this.currentFocusConstraint=undefined,focusedItem&&(focusedItem.element?focusedItem.element.classList.remove("focused"):focusedItem.focusElement?focusedItem.focusElement.classList.remove("focused"):focusedItem.classList&&focusedItem.classList.remove("focused")),window.setFocusedItem(item),window.getFocusedItem().focus(focusEvent,event),isFocused=!0,PubSub.publish(FocusController.Event.FOCUS_CHANGED,focusEvent,event)),isFocused}});var FocusController=Class.create(FocusTarget,{isFocusController:!0,initialize:function($super,element){var style;this.mcdEventSource=new KeyboardMCDEventSource(this),this.focusMap=new FocusMap,$super(element,{focusable:!1,targetable:!0}),Config.enableFocusableIndicator&&(style=document.createElement("style"),style.textContent="*[data-focusable] { outline: 2px solid rgba(255, 252, 0, 0.6) !important;background: rgba(255, 252, 0, 0.6) !important; }",document.head.appendChild(style)),Config.enableFocusDebugBoundingBox&&(style=document.createElement("style"),style.textContent="*:focus { outline: 2px solid rgba(255, 0, 246, 0.6) !important;background: rgba(255, 0, 246, 0.6) !important; }",document.head.appendChild(style)),this.hasOwnProperty("isPlatformFocusController")||Object.defineProperty(this,"isPlatformFocusController",{value:!1}),this.canRefresh=!0},getFocusedItem:function(){return window.getFocusedItem()},addFocusableItem:function(item){return this.focusMap.addItem(item),this},removeFocusableItem:function(item){return this.focusMap.removeItem(item),this},findParentFocusTarget:function(){return!0},setFocus:function(item,event,saveHistory){return item=item&&item.isFocusTarget?item:undefined,item&&this.focusMap.setFocus(item,event,saveHistory),this},focusFirstChild:function(parent){return typeof parent=="undefined"&&(parent=this),this.focusMap.focusFirstChild(parent)},clearFocusHistory:function(){return this.focusMap.clearHistory(),this},makeFocusHistoryItem:function(item,event){return this.focusMap.history.push(new FocusHistoryItem(item,event)),this},getLastFocusedItem:function(){var item=this.getFocusedItem(),history;return this.focusMap.hasItem(item)||(history=this.focusMap.history,history&&history.length&&(item=history[history.length-1].prevTarget)),item},getFocusController:function(){return this},setDefaultFocus:function(){return this.focusFirstChild()},dispatchMCDEvent:function(event){var shouldTraverse=!0,originalItem=event.getTarget(),item=originalItem,dispatchTargets=[],i,dontThrowBoundary;if(!event.isCanceled()){while(item)dispatchTargets.unshift(item),item=item.getParentFocusTarget();dispatchTargets.length===0&&dispatchTargets.push(this);for(i=0;i<dispatchTargets.length;i++){dispatchTargets[i].handleMCDEvent(event,!0);if(event.isCanceled())break}event.eventType!==0&&!event.isCanceled()&&!event.isDefaultPrevented()&&event.getTarget()&&!event.getTarget().isFocused()&&event.getTarget().requestFocus(event);if(!event.isCanceled())for(i=dispatchTargets.length-1;i>=0;i--){dispatchTargets[i].handleMCDEvent(event,!1);if(event.isCanceled())break}}if(!event.isCanceled()&&!event.isDefaultPrevented())switch(event.eventType){case MCDEvent.EventType.Joystick.LEFT:typeof originalItem.onLeft!="undefined"&&(shouldTraverse=!1,dontThrowBoundary=originalItem._onMcdLeft());break;case MCDEvent.EventType.Joystick.RIGHT:typeof originalItem.onRight!="undefined"&&(shouldTraverse=!1,dontThrowBoundary=originalItem._onMcdRight());break;case MCDEvent.EventType.Joystick.UP:typeof originalItem.onUp!="undefined"&&(shouldTraverse=!1,dontThrowBoundary=originalItem._onMcdUp());break;case MCDEvent.EventType.Joystick.DOWN:typeof originalItem.onDown!="undefined"&&(shouldTraverse=!1,dontThrowBoundary=originalItem._onMcdDown())}return shouldTraverse&&!event.isDefaultPrevented()&&!event.isCanceled()&&this.focusMap.handleMCDEvent(event),!dontThrowBoundary&&!event.isCanceled()&&!event.isDefaultPrevented()&&shouldTraverse&&this.publish(FocusController.Event.FOCUS_BOUNDARY_HIT,event,this),event.eventType&MCDEvent.EventType.BACK&&(event.isCanceled()||this.publish(FocusController.Event.BACK_BUTTON_EVENT,event,this)),event.eventType&MCDEvent.EventType.HOME&&(event.isCanceled()||this.publish(FocusController.Event.HOME_BUTTON_EVENT,event,this)),event.eventType&MCDEvent.EventType.MEDIA&&(event.isCanceled()||this.publish(FocusController.Event.MEDIA_BUTTON_EVENT,event,this)),event.eventType&MCDEvent.EventType.NAV&&(event.isCanceled()||this.publish(FocusController.Event.NAV_BUTTON_EVENT,event,this)),this},enableRefresh:function(){this.focusMap.canRefresh=!0},disableRefresh:function(){this.focusMap.canRefresh=!1},refresh:function(){return this.focusMap.canRefresh&&this.focusMap.refresh(),this},setPlatformHasFocus:function(bool){return this._platformHasFocus=bool,this},getPlatformHasFocus:function(){return this._platformHasFocus}});return FocusController.Event={FOCUS_BOUNDARY_HIT:"focus-boundary-hit",FOCUS_CHANGED:"focus-changed",HOME_BUTTON_EVENT:"home-button-event",BACK_BUTTON_EVENT:"back-button-event",MEDIA_BUTTON_EVENT:"media-button-event",NAV_BUTTON_EVENT:"nav-button-event",WINDOW_BLUR_EVENT:"window-blur-event",WINDOW_FOCUS_EVENT:"window-focus-event"},Object.freeze(FocusController.Event),FocusController});