define(["require","common/Class","common/Model","common/ObjectUtils","common/MCDEvent","common/DOMHelper","common/lib/Math","common/ui/Control","common/ui/ListItemView","common/ArrayList","common/Exception","common/lib/SFX"],function(require){"use strict";var Class=require("common/Class"),Model=require("common/Model"),ObjectUtils=require("common/ObjectUtils"),MCDEvent=require("common/MCDEvent"),DOMHelper=require("common/DOMHelper"),OCMath=require("common/lib/Math"),Control=require("common/ui/Control"),ListItemView=require("common/ui/ListItemView"),ArrayList=require("common/ArrayList"),Exception=require("common/Exception"),SFX=require("common/lib/SFX"),regExpAdjacent=/adjacent-selected-\d+/g,cleanAdjacencyClasses=function(li){li.className=li.className.replace(regExpAdjacent,"")},queue=function(e){this._queue.unshift(e)},dequeue=function(){if(this.disabled){this._queue=[];return}this._queue.length&&this._handleMCDEvents(this._queue.pop())},setupArrayList=function(){var arrayList=this.model.get("arrayList");if(arrayList instanceof ArrayList){var Instance=arrayList.itemModel||Model;for(var i=0,ii=arrayList.length,item;i<ii;i++)item=arrayList.getItem(i),item instanceof Instance||arrayList.silent().updateItem(i,new Instance(item))}else this.model.set("arrayList",new ArrayList(arrayList,{itemModel:Model,legacy:!0})),arrayList=this.getArrayList();arrayList.isSubscribed(Model.Event.EV_CHANGED,this.modelChangeMethod)||arrayList.subscribe(Model.Event.EV_CHANGED,this.modelChangeMethod)},reIndex=function(arrayList,fromIndex){var index=fromIndex||0;for(var i=index,ii=arrayList.length;i<ii;i++)arrayList[i]&&arrayList[i].set("index",i)},ListViewLegacy=Class.create(Control,{hasOwnWheelFocus:!0,initialize:function($super,attrs,autoRender){this._configs=attrs||{},this._queue=[];var itemChanged=this.get("itemChanged"),itemSelected=this.get("itemSelected"),beforeChange=this.get("beforeChange"),pastLast=this.get("pastLast"),beforeFirst=this.get("beforeFirst");itemChanged&&typeof itemChanged=="function"&&(this.addItemChangedListener(itemChanged),this.deleteProp("itemChanged")),itemSelected&&(typeof itemSelected=="function"&&this.addItemSelectedListener(itemSelected),this.deleteProp("itemSelected")),beforeChange&&(typeof beforeChange=="function"&&this.addBeforeChangeListener(beforeChange),this.deleteProp("beforeChange")),pastLast&&(typeof pastLast=="function"&&this.addPastLastListener(pastLast),this.deleteProp("pastLastListener")),beforeFirst&&(typeof beforeFirst=="function"&&this.addBeforeFirstListener(beforeFirst),this.deleteProp("beforeFirst")),this.setBaseListeners(this._configs instanceof Model?this._configs.getAll():this._configs),this.itemClickListeners=[],this.itemLongClickListeners=[],typeof this.get("initialIndex")!="undefined"&&(this.initialIndex=this.get("initialIndex")),$super(this._configs,autoRender),this.set("selectedIndex",0),this.getArrayList().selectedIndex=0,this.modelChangeMethod=this.onModelChange.bind(this),setupArrayList.call(this),(this.get("visibleLength")<0||this.get("visibleLength")!==Math.round(this.get("visibleLength")))&&this.set("visibleLength",5,!0),this.get("visibleBuffer")<0||this.get("visibleBuffer")!==Math.round(this.get("visibleBuffer"))?this.set("visibleBuffer",3,!0):this.get("visibleBuffer")===0&&(this.fullArrayList=!0),this.get("itemClick")&&this.itemClickListeners.push(this.get("itemClick")),this.get("itemLongClick")&&this.itemLongClickListeners.push(this.get("itemLongClick")),this.actualVisibleLength=this.get("visibleLength")+this.get("visibleBuffer")*2,this.addMCDEventListener(MCDEvent.EventType.Joystick.FIRE|MCDEvent.EventType.Joystick.FIRE_AND_HOLD|MCDEvent.EventType.Wheel.FORWARD|MCDEvent.EventType.Wheel.BACK,this._handleMCDEvents.bind(this)),this._animating=!1,this.listItems=[]},_getControlDefaults:function($super){return ObjectUtils.merge($super(),{selectedIndex:0,visibleLength:5,visibleBuffer:3,listItemViewType:ListItemView,initialIndex:undefined,itemChanged:undefined,itemSelected:undefined,beforeChange:undefined,pastLast:undefined,beforeFirst:undefined,itemClick:undefined,itemLongClick:undefined,childProps:undefined,parentBoundingClientRect:undefined,listItemTemplate:undefined})},_getModelDefaults:function(){return{arrayList:new ArrayList}},_generateElement:function(notDefault){var element=document.createElement("ul"),wrapper=document.createElement("div"),classes=this.get("classNames");for(var i=0,ii=classes.length;i<ii;i++)wrapper.classList.add(classes[i]);return this.get("noStyle")||(element.classList.add("oc-listview"),wrapper.classList.add("oc-listview-container"),notDefault||wrapper.classList.add("vertical")),wrapper.appendChild(element),wrapper},onPostRender:function(){var i=0,ii=this.fullArrayList?this.getArrayList().length:Math.min(this.getArrayList().length,this.actualVisibleLength);this.set("selectedIndex",0),this.getArrayList().selectedIndex=0;for(;i<ii;i++)this._push(i,!1,!0);typeof this.initialIndex!="undefined"&&this.set("selectedIndex",this.initialIndex),this._setSelectedElement(this.getSelectedElement()),this.getArrayList().length&&this.getArrayList().length<=this.actualVisibleLength&&(this.fullArrayList=!0)},_createListItemView:function(dataindex){var node,ViewType=this.get("listItemViewType"),listItemTemplate=this.get("listItemTemplate")||this.model.get("listItemTemplate"),model=this.getArrayList().getItem(dataindex),configs={model:model},childProps=this.get("childProps");return childProps&&(childProps instanceof Model&&(childProps=childProps.flatten()),configs=ObjectUtils.merge(childProps,configs)),listItemTemplate&&(configs.template=listItemTemplate),node=new ViewType(configs),node.model!==model&&this.getArrayList().silent().splice(dataindex,1,node.model.getAll()),node.set("index",dataindex),node.focusable=!1,node},_push:function(dataindex,infinite,silent){var li=this.listItems[dataindex],currentIndex=this.getCurrentIndex();return li||(li=this._createListItemView(dataindex),this.listItems[dataindex]=li),infinite&&li.element.classList.add("after-selected"),li=li.render(this.getListElement()),dataindex===currentIndex?(li.element.classList.add("selected"),this.selectedElement=li.element,(typeof silent=="undefined"||silent===!1)&&this._publishSelectedEvent()):this._setAdjacencyClasses(li.element,Math.abs(currentIndex-dataindex),dataindex-currentIndex<0),li.element},_pop:function(){var index,lastEl=this.getListElement().lastChild;return lastEl?(index=lastEl.getAttribute("data-adapter-index"),this.getCurrentIndex()===this.getArrayList().length&&this._selectPrevious()):Log.error("This is an empty list; nothing to pop"),this.listItems[index].remove()},_shift:function(removeItem){var firstChild=this.getListElement().firstChild,index=firstChild.getControl().get("index"),item=this.listItems[index];return item.remove(),removeItem&&(item=this.listItems.shift()),item},_unshift:function(dataindex,fromModel){var li=fromModel?this._createListItemView(dataindex):this.listItems[dataindex],selectedIndex=this.getCurrentIndex();return fromModel&&dataindex===0&&this.listItems.unshift(li),li||(li=this._createListItemView(dataindex),this.listItems[dataindex]=li),li=li.render(this.getListElement()),this.getListElement().hasChildNodes()?li=this.getListElement().insertBefore(li.element,this.getListElement().firstChild):li=this.getListElement().appendChild(li.element),dataindex===selectedIndex?(fromModel&&this.set("selectedIndex",selectedIndex+1,!1),this.getSelectedElement().classList.add("selected"),this.listItems[selectedIndex].element.classList.remove("selected"),this._publishChangeEvent()):this._setAdjacencyClasses(li,Math.abs(selectedIndex-dataindex),!0),li},_splice:function($super,index,dataindex){var li=this.listItems[dataindex]||this._createListItemView(dataindex);return li=this.getListElement().insertBefore(li.element,this.getListElement().getChild(index)),li},getBottomIndex:function(){return this.getListElement().lastChild&&parseInt(this.getListElement().lastChild.getAttribute("data-adapter-index"),10)||0},getTopIndex:function(){return this.getListElement().firstChild&&parseInt(this.getListElement().firstChild.getAttribute("data-adapter-index"),10)||0},getParentBoundingClientRect:function(){return this.get("parentBoundingClientRect")||this.element.getBoundingClientRect()},_onPropsChange:function(evt,type,prop,newValue,oldValue){type===Model.Event.TYPE.PROP&&prop==="selectedIndex"&&this._onIndexChange(newValue,oldValue)},onModelChange:function(evt,type,prop,newValue,oldValue){if(type===Model.Event.TYPE.PROP){var li,shouldPublish=!1,bottomIndex=this.getBottomIndex(),topIndex=this.getTopIndex(),selectedIndex=this.getCurrentIndex(),arrayLen=this.fullArrayList||this.getArrayList().length<this.actualVisibleLength?this.getArrayList().length:this.actualVisibleLength;switch(prop){case Model.Event.TYPE.PUSH:bottomIndex<=arrayLen&&this._push(Math.max(arrayLen-1,0));break;case Model.Event.TYPE.POP:arrayLen<=bottomIndex&&this._pop();break;case Model.Event.TYPE.SHIFT:topIndex===0&&this._shift(!0),this.getArrayList().length&&(reIndex(this.listItems,0),selectedIndex===0&&this._setSelectedElement(this.listItems[0].element));break;case Model.Event.TYPE.UNSHIFT:topIndex===0&&this._unshift(0,!0),reIndex(this.listItems,0);break;case Model.Event.TYPE.SPLICE:var newEndpoint,index=arguments[3],removed=arguments[4],added=arguments[5],newWritesLength=added-removed;index<0&&(index=this.getArrayList().length+index),newEndpoint=index+newWritesLength;if(removed){for(var i=index,ii=index+removed;i<ii;i++)li=this.listItems[i],i>=topIndex&&i<=bottomIndex&&li.remove();this.listItems.splice(index,removed)}if(added)for(var j=Math.min(index,newEndpoint),jj=index+added;j<jj;j++)li=this._createListItemView(j),j>=topIndex&&j<=bottomIndex&&(li.render(this.getListElement()),this.getListElement().insertBefore(li.element,this.getElementByMinIndex(j+1))),j<=this.listItems.length&&this.listItems.splice(j,0,li);reIndex(this.listItems,index),this.getCurrentIndex()!==0&&!this.getSelectedElement()&&this.set("selectedIndex",this.getArrayList().length-1,!0);break;case Model.Event.TYPE.CLEAR:this.set("selectedIndex",0,!0),this.getListElement().innerHTML="",this.listItems=[];break;case Model.Event.TYPE.CONCAT:var newindex=oldValue-1;this.getListElement().classList.add("no-animate"),window.requestAnimationFrame(function(){while(this.getListElement().childNodes.length<arrayLen)this._push(++newindex);window.requestAnimationFrame(function(){this.getListElement().classList.remove("no-animate")}.bind(this))}.bind(this));break;case Model.Event.TYPE.REPLACE:this.set("selectedIndex",0,!0),this.getListElement().innerHTML="",this.listItems=[],this.getListElement().classList.add("no-animate"),setupArrayList.call(this);for(var k=0,kk=newValue.length;k<kk;k++)this._push(k);this.getListElement().classList.remove("no-animate");break;case Model.Event.TYPE.SHUFFLE:this.set("selectedIndex",0,!0),newindex=-1,this.getListElement().innerHTML="",this.listItems=[];while(this.getListElement().childNodes.length<arrayLen)this._push(++newindex);this._setSelectedElement(this.getListElement().firstChild),reIndex(this.listItems,0),shouldPublish=!0;break;case"childArraySelectedIndex":if(newValue<0||newValue>=this.getArrayList().length){Log.warn("Attempt to set an index that is out of bounds of the ArrayList.");return}this.set("selectedIndex",newValue,!0),oldValue-1===newValue?this._selectPrevious():oldValue+1===newValue?this._selectNext():this._select(newValue)}window.requestAnimationFrame(function(){this.getSelectedElement()&&this._setSelectedElement(this.getSelectedElement()),shouldPublish&&(this._publishChangeEvent(),this._publishSelectedEvent()),this.getArrayList().length&&this.getArrayList().length<this.actualVisibleLength&&(this.fullArrayList=!0)}.bind(this))}},_select:function(index,callback){if(!this.isRendered)return;index=OCMath.clamp(index,0,this.getArrayList().length-1),this.initialIndex=null;var selectedElement,finish,direction,onTransitionComplete,oldIndex,arrayList=this.getArrayList(),topIndex=this.getTopIndex(),arrayLen=arrayList.length,buffer=this.actualVisibleLength/2,first=index-Math.ceil(buffer),last=index+Math.floor(buffer),listElement=this.getListElement(),oldSelected=listElement.querySelector(".selected");oldIndex=oldSelected?parseInt(oldSelected.getAttribute("data-adapter-index"),10):this._previousIndex;if(!this.fullArrayList&&arrayLen>this.actualVisibleLength){while(first<0)first++,last++;while(last>=arrayLen)last--,first--}if(!this.fullArrayList){if(index<oldIndex){finish=Math.max(index-Math.ceil(buffer),0),direction="lastChild";while(--topIndex>=finish)this._unshift(topIndex)}else direction="firstChild";onTransitionComplete=function(){while(listElement.childNodes.length>this.actualVisibleLength)listElement.removeChild(listElement[direction]);this._publishSelectedEvent(),this._publishChangeEvent(),callback&&callback(),dequeue.call(this)}.bind(this)}selectedElement=this.getSelectedElement(),!this.fullArrayList&&selectedElement?DOMHelper.addSingleTransitionEndEventListener(selectedElement,onTransitionComplete,"-webkit-transform"):(this._publishSelectedEvent(),this._publishChangeEvent(),callback&&callback()),this._setSelectedElement(selectedElement)},_selectNext:function(dispatchSelectedEvent){dispatchSelectedEvent=typeof dispatchSelectedEvent!="undefined"?dispatchSelectedEvent:!0;var selectedIndex=this.getCurrentIndex(),selectedElement=this.getSelectedElement(),arrayList=this.getArrayList(),buffer=Math.floor(this.actualVisibleLength/2),bottomIndex=this.getBottomIndex(),infinite=!1,onTransitionComplete=function(e){var listElement=this.getListElement();if(e)if(e!==!0&&bottomIndex<arrayList.length)this._push(bottomIndex),this._shift();else while(listElement.childNodes.length>this.actualVisibleLength)listElement.removeChild(listElement.firstChild);SFX.play("scroll"),this._publishChangeEvent(),dispatchSelectedEvent&&this._publishSelectedEvent(),this._animating=!1,dequeue.call(this)}.bind(this);if(selectedIndex===0&&!this.fullArrayList){var i=-1;infinite=!0;while(++i<this.actualVisibleLength)this._push(i,infinite);selectedElement=this.getSelectedElement()}!this.fullArrayList&&!infinite&&selectedIndex>buffer&&++bottomIndex<arrayList.length&&!this.getElementByIndex(bottomIndex)&&(this._animating=!0,DOMHelper.addSingleTransitionEndEventListener(selectedElement,onTransitionComplete,"-webkit-transform")),this._setSelectedElement(selectedElement),this._animating||(this._animating=!0,onTransitionComplete(infinite))},_selectPrevious:function(dispatchSelectedEvent){dispatchSelectedEvent=typeof dispatchSelectedEvent!="undefined"?dispatchSelectedEvent:!0;var selectedIndex=this.getCurrentIndex(),selectedElement=this.getSelectedElement(),arrayList=this.getArrayList(),arrayLen=arrayList.length,buffer=arrayLen-Math.floor(this.actualVisibleLength/2),topIndex=this.getTopIndex(),infinite=!1,onTransitionComplete=function(e){var listElement=this.getListElement();if(e)if(e!==!0)this._unshift(topIndex),this._pop();else while(listElement.childNodes.length>=this.actualVisibleLength)listElement.removeChild(listElement.firstChild);SFX.play("scroll"),this._publishChangeEvent(),dispatchSelectedEvent&&this._publishSelectedEvent(),this._animating=!1,dequeue.call(this)}.bind(this);if(selectedIndex===arrayList.length-1&&!this.fullArrayList){var i=arrayLen-this.actualVisibleLength;infinite=!0;while(++i<arrayLen)this._push(i).classList.add("before-selected");selectedElement=this.getSelectedElement()}!this.fullArrayList&&!infinite&&selectedIndex<=buffer&&topIndex>0&&!this.getElementByIndex(--topIndex)&&(this._animating=!0,DOMHelper.addSingleTransitionEndEventListener(selectedElement,onTransitionComplete,"-webkit-transform")),this._setSelectedElement(selectedElement),this._animating||(this._animating=!0,onTransitionComplete(infinite))},isAnimating:function(){return this._animating},_isInViewPort:function(index){var selectedElement=this.getElementByIndex(index),selectedBounds=selectedElement&&selectedElement.getBoundingClientRect(),parentBounds=this.getParentBoundingClientRect();return selectedElement&&selectedBounds.top>=parentBounds.top&&selectedBounds.bottom<=parentBounds.bottom},_setSelectedElement:function(element){var neighbor,adjacencyLevel,oldSelected;element&&element.parentElement&&(oldSelected=element.parentElement.querySelector(".selected")),oldSelected&&oldSelected.classList.remove("selected");if(element){cleanAdjacencyClasses.call(this,element),element.classList.add("selected"),this._setAdjacencyClasses(element),neighbor=element,adjacencyLevel=1;while(neighbor.previousElementSibling)this._setAdjacencyClasses(neighbor.previousElementSibling,adjacencyLevel++,!0),neighbor=neighbor.previousElementSibling;neighbor=element,adjacencyLevel=1;while(neighbor.nextElementSibling)this._setAdjacencyClasses(neighbor.nextElementSibling,adjacencyLevel++,!1),neighbor=neighbor.nextElementSibling}},_clickHandler:function(event){if(this._animating)return;var index,item,isSelected,isFireEvent=event.eventType===MCDEvent.EventType.Joystick.FIRE,target=event.sourceEvent.target;while(target.parentElement!==this.getListElement()&&target!==this.getListElement())target=target.parentElement;if(target&&target.nodeName==="LI"&&target.hasAttribute("data-adapter-index")){index=parseInt(target.getAttribute("data-adapter-index"),10);if(this.getControlItem(index).get("disabled")||this.get("disabled"))return;isSelected=index===this.getCurrentIndex(),isSelected||(isFireEvent&&DOMHelper.addSingleTransitionEndEventListener(target,function(){window.setTimeout(function(){this.publish(ListViewLegacy.Event.SELECTED_ITEM_CLICKED,this,item,target)}.bind(this),125)}.bind(this),"-webkit-transform"),this.set("selectedIndex",index)),item=this.getSelectedItem();if(event.eventType===MCDEvent.EventType.Joystick.FIRE){for(var i=0,ii=this.itemClickListeners.length;i<ii;i++)this.itemClickListeners[i](this,item,target,isSelected);isSelected&&this.publish(ListViewLegacy.Event.SELECTED_ITEM_CLICKED,this,item,target)}else{for(var j=0,jj=this.itemLongClickListeners.length;j<jj;j++)this.itemLongClickListeners[j](this,item,target,isSelected);isSelected&&this.publish(ListViewLegacy.Event.SELECTED_ITEM_LONG_CLICKED,this,item,target,isSelected)}}},_fire:function(e){var element=this.getSelectedElement();if(!element)throw new Exception("Cannot all Fire event when selected element is null.",Exception.ErrorCode.STATE_UNRECOGNIZED);var item=this.getSelectedItem(),control=element.getControl();if(!control||control.get("disabled"))return;if(element)if(e.eventType===MCDEvent.EventType.Joystick.FIRE){for(var i=0,ii=this.itemClickListeners.length;i<ii;i++)this.itemClickListeners[i](this,item,element);this.publish(ListViewLegacy.Event.SELECTED_ITEM_CLICKED,this,item,element)}else{for(var j=0,jj=this.itemLongClickListeners.length;j<jj;j++)this.itemLongClickListeners[j](this,item,element);this.publish(ListViewLegacy.Event.SELECTED_ITEM_LONG_CLICKED,this,item,element)}},getElementByMinIndex:function(index){for(var i=index,ii=index+this.listItems.length,item;i<ii;i++){item=this.getListElement().querySelector('li[data-adapter-index="'+i+'"]');if(item)return item}return undefined},getElementByIndex:function(index){return this.getListElement().querySelector('li[data-adapter-index="'+index+'"]')},getSelectedItem:function(){return this.getItemModel(this.getCurrentIndex())},getSelectedListItem:function(){return this.getListItem(this.getCurrentIndex())},getSelectedElement:function(){return this.getElementByIndex(this.getCurrentIndex())},getCurrentIndex:function(){return this.get("selectedIndex")},getItemModel:function(index){return this.getArrayList()&&this.getArrayList().getItem(index)},getControlItem:function(index){return index instanceof Model&&(index=this.getArrayList().indexOf(index)),this.listItems[index]},getListItem:function(index){return this.listItems[index]},getArrayList:function(){return this.model.get("arrayList")},getListElement:function(){return this.element.firstChild},addItems:function(items){var i;if(this.getArrayList()&&Array.isArray(items))for(i=0;i<items.length;i++)this.getArrayList().push(items[i]);return this},clear:function(){return this.getArrayList()&&this.getArrayList().clear(),this},addItemClickListener:function(listener){return this.itemClickListeners.push(listener),this},addSelectedItemClickedListener:function(listener){return this.subscribe(ListViewLegacy.Event.SELECTED_ITEM_CLICKED,listener)},removeSelectedItemClickedListener:function(listener){return this.unsubscribe(ListViewLegacy.Event.SELECTED_ITEM_CLICKED,listener)},clearAllClickListeners:function(){this.itemClickListeners=[],this.itemLongClickListeners=[]},addItemLongClickListener:function(listener){return this.itemLongClickListeners.push(listener),this},addItemChangedListener:function(listener){return this.subscribe(ListViewLegacy.Event.CHANGED,listener)},removeItemChangedListener:function(listener){return this.unsubscribe(ListViewLegacy.Event.CHANGED,listener)},addItemSelectedListener:function(listener){return this.subscribe(ListViewLegacy.Event.SELECTED,listener)},removeItemSelectedListener:function(listener){return this.unsubscribe(ListViewLegacy.Event.SELECTED,listener)},addPastLastListener:function(listener){return this.subscribe(ListViewLegacy.Event.PASTLAST,listener)},removePastLastListener:function(listener){return this.unsubscribe(ListViewLegacy.Event.PASTLAST,listener)},addBeforeFirstListener:function(listener){return this.subscribe(ListViewLegacy.Event.BEFOREFIRST,listener)},removeBeforeFirstListener:function(listener){return this.unsubscribe(ListViewLegacy.Event.BEFOREFIRST,listener)},addBeforeChangeListener:function(listener){return this.subscribe(ListViewLegacy.Event.BEFORE_CHANGE,listener)},removeBeforeChangeListener:function(listener){return this.unsubscribe(ListViewLegacy.Event.BEFORE_CHANGE,listener)},setBaseListeners:function(listeners){typeof listeners.focusListener=="function"&&this.addFocusListener(listeners.focusListener),typeof listeners.blurListener=="function"&&this.addBlurListener(listeners.blurListener),typeof listeners.itemClickListener=="function"&&this.addItemClickListener(listeners.itemClickListener),typeof listeners.itemChangedListener=="function"&&this.addItemChangedListener(listeners.itemChangedListener),typeof listeners.itemSelectedListener=="function"&&this.addItemSelectedListener(listeners.itemSelectedListener),typeof listeners.focusable=="boolean"&&this.setFocusable(listeners.focusable),typeof listeners.selectedItemClickedListener=="function"&&this.addSelectedItemClickedListener(listeners.selectedItemClickedListener),typeof listeners.beforeChangeListener=="function"&&this.addBeforeChangeListener(listeners.beforeChangeListener)},_publishChangeEvent:function(){this.publish(ListViewLegacy.Event.CHANGED,this,this.getSelectedItem())},_publishBeforeChangeEvent:function(){this.publish(ListViewLegacy.Event.BEFORE_CHANGE,this,this.getSelectedItem())},_publishSelectedEvent:function(){this.publish(ListViewLegacy.Event.SELECTED,this,this.getSelectedItem(),this.getSelectedElement())},_setMoreItemsClasses:function(){this._isInViewPort(this.getTopIndex())?this.element.classList.remove("more-above"):this.element.classList.add("more-above"),this._isInViewPort(this.getBottomIndex())?this.element.classList.remove("more-below"):this.element.classList.add("more-below")},_handleMCDEvents:function(e){var mask=MCDEvent.EventType.Joystick.FIRE|MCDEvent.EventType.Joystick.FIRE_AND_HOLD,selectedIndex=this.getCurrentIndex(),arrayLen=this.getArrayList().length;if(this.disabled)return!1;if(e.eventType===MCDEvent.EventType.Wheel.FORWARD){if(!this._animating){if(selectedIndex===-1&&e.isRepeat())return;this._publishBeforeChangeEvent(),this.set("selectedIndex",++selectedIndex)}else queue.call(this,e);e.preventDefault()}else if(e.eventType===MCDEvent.EventType.Wheel.BACK){if(!this._animating){if(selectedIndex===arrayLen&&e.isRepeat())return;this._publishBeforeChangeEvent(),this.set("selectedIndex",--selectedIndex)}else queue.call(this,e);e.preventDefault()}else e.eventType&mask&&!e.isRepeat()&&(e.sourceEvent&&(e.sourceEvent.type==="mousedown"||e.sourceEvent.type==="touchstart")&&e.sourceEvent.target&&e.sourceEvent.target.compareDocumentPosition(this.element)&this.element.DOCUMENT_POSITION_CONTAINS?this._clickHandler(e):this._fire(e),e.preventDefault())},_onIndexChange:function(newValue,oldValue){var arrayLen=this.getArrayList().length,visLen=this.get("visibleLength"),shouldContinue=!0;newValue===oldValue||newValue===0&&!oldValue?shouldContinue=!1:newValue<0?newValue===-2&&oldValue===-1?(this.set("selectedIndex",arrayLen-1,!0),newValue=arrayLen-1,oldValue=0):arrayLen>visLen?(this.set("selectedIndex",arrayLen,!0),this.publish(ListViewLegacy.Event.BEFOREFIRST,this,this.getSelectedItem()),shouldContinue=!1):(this.set("selectedIndex",oldValue,!0),this.publish(ListViewLegacy.Event.BEFOREFIRST,this,this.getSelectedItem()),shouldContinue=!1):newValue>=arrayLen&&(newValue===arrayLen+1&&oldValue===arrayLen?(this.set("selectedIndex",0,!0),newValue=0,oldValue=arrayLen-1):arrayLen>visLen?(this.set("selectedIndex",-1,!0),this.publish(ListViewLegacy.Event.PASTLAST,this,this.getSelectedItem()),shouldContinue=!1):(this.set("selectedIndex",oldValue,!0),this.publish(ListViewLegacy.Event.PASTLAST,this,this.getSelectedItem()),shouldContinue=!1)),shouldContinue&&(this._previousIndex=oldValue,Math.abs(newValue-oldValue)>1?this._select(newValue):newValue>oldValue?this._selectNext():this._selectPrevious())},_setAdjacencyClasses:function(li,adjacentIndex,before){var newClass=this._getAdjacencyClasses(adjacentIndex,before).join(" ");li.classList.remove("before-selected"),li.classList.remove("after-selected"),regExpAdjacent.test(li.className)?li.className=li.className.replace(regExpAdjacent,newClass):li.className+=(li.className.length>0?" ":"")+newClass},_getAdjacencyClasses:function(adjacentIndex,before){return typeof adjacentIndex!="undefined"&&typeof before!="undefined"?["adjacent-selected-"+adjacentIndex,(before?"before":"after")+"-selected"]:[]}});return ListViewLegacy.Event={CHANGED:"/ui/control/listview/item/changed",PASTLAST:"/ui/control/listview/item/nextpast",BEFOREFIRST:"/ui/control/listview/item/beforefirst",SELECTED:"/ui/control/listview/item/selected",SELECTED_ITEM_CLICKED:"/ui/control/listview/item/selected/clicked",SELECTED_ITEM_LONG_CLICKED:"/ui/control/listview/item/selected/longclicked",BEFORE_CHANGE:"/ui/control/listview/item/beforechanged"},Object.freeze(ListViewLegacy.Event),ListViewLegacy});